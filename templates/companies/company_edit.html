{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/add_company.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<title>تعديل شركة - {{ company.name }} - نظام إدارة الشركات</title>
<meta name="title" content="تعديل شركة - {{ company.name }} - نظام إدارة الشركات">
<meta name="description" content="تعديل بيانات الشركة {{ company.name }} في نظام إدارة الشركات.">
{% endblock %}

{% block content %}
<div class="company-form-container">
  <!-- Header -->
  <div class="form-header">
    <div class="header-content">
      <a href="{% url 'company_list' %}" class="back-link">
        <i class="fas fa-arrow-right"></i>
        العودة للقائمة
      </a>
      <h1 class="page-title">
        <i class="fas fa-edit"></i>
        تعديل شركة: {{ company.name }}
      </h1>
      <p class="page-subtitle">تعديل بيانات الشركة المسجلة في النظام</p>
      <div class="company-info-badge">
        <span class="badge-item">
          <i class="fas fa-hashtag"></i>
          الرقم: #{{ company.id }}
        </span>
        <span class="badge-item">
          <i class="fas fa-calendar-plus"></i>
          تاريخ الإضافة: {{ company.created_at|date:"Y/m/d" }}
        </span>
      </div>
    </div>
    <div class="header-icon">
      <i class="fas fa-edit"></i>
    </div>
  </div>

  <!-- Messages -->
  {% if messages %}
  <div class="messages-container">
    {% for message in messages %}
    <div class="message alert-{{ message.tags }}">
      <div class="message-icon">
        {% if message.tags == 'success' %}
        <i class="fas fa-check-circle"></i>
        {% elif message.tags == 'error' %}
        <i class="fas fa-exclamation-circle"></i>
        {% elif message.tags == 'warning' %}
        <i class="fas fa-exclamation-triangle"></i>
        {% else %}
        <i class="fas fa-info-circle"></i>
        {% endif %}
      </div>
      <div class="message-content">
        <p>{{ message }}</p>
      </div>
      <button type="button" class="close-message">
        <i class="fas fa-times"></i>
      </button>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  <!-- Form -->
  <div class="form-card">
    <form method="post" class="company-form" id="editCompanyForm">
      {% csrf_token %}
      
      <!-- Company Basic Information -->
      <div class="form-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-info-circle"></i>
            المعلومات الأساسية
          </h2>
          <div class="section-actions">
            <span class="required-hint">* الحقول المطلوبة</span>
          </div>
        </div>
        
        <div class="form-grid">
          <!-- Name Field -->
          <div class="form-group {% if form.name.errors %}has-error{% endif %}">
            <label for="{{ form.name.id_for_label }}" class="form-label">
              <span class="label-text">
                <i class="fas fa-signature"></i>
                اسم الشركة
                <span class="required">*</span>
              </span>
            </label>
            <div class="input-group">
              {{ form.name }}
              <div class="input-icon">
                <i class="fas fa-building"></i>
              </div>
            </div>
            {% if form.name.help_text %}
            <small class="form-help">{{ form.name.help_text }}</small>
            {% endif %}
            {% if form.name.errors %}
            <div class="error-messages">
              {% for error in form.name.errors %}
              <span class="error-message">{{ error }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>

          <!-- Email Field (Address) -->
          <div class="form-group {% if form.email.errors %}has-error{% endif %}">
            <label for="{{ form.email.id_for_label }}" class="form-label">
              <span class="label-text">
                <i class="fas fa-map-marker-alt"></i>
                عنوان الشركة
                <span class="required">*</span>
              </span>
            </label>
            <div class="input-group">
              {{ form.email }}
              <div class="input-icon">
                <i class="fas fa-location-dot"></i>
              </div>
            </div>
            {% if form.email.help_text %}
            <small class="form-help">{{ form.email.help_text }}</small>
            {% endif %}
            {% if form.email.errors %}
            <div class="error-messages">
              {% for error in form.email.errors %}
              <span class="error-message">{{ error }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>

          <!-- Website Field -->
          <div class="form-group {% if form.website.errors %}has-error{% endif %}">
            <label for="{{ form.website.id_for_label }}" class="form-label">
              <span class="label-text">
                <i class="fas fa-globe"></i>
                موقع الشركة
              </span>
            </label>
            <div class="input-group">
              {{ form.website }}
              <div class="input-icon">
                <i class="fas fa-link"></i>
              </div>
            </div>
            {% if form.website.help_text %}
            <small class="form-help">{{ form.website.help_text }}</small>
            {% endif %}
            {% if form.website.errors %}
            <div class="error-messages">
              {% for error in form.website.errors %}
              <span class="error-message">{{ error }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>

          <!-- End Date Field -->
          <div class="form-group {% if form.end_date.errors %}has-error{% endif %}">
            <label for="{{ form.end_date.id_for_label }}" class="form-label">
              <span class="label-text">
                <i class="fas fa-calendar-times"></i>
                تاريخ الانتهاء
              </span>
            </label>
            <div class="input-group">
              {{ form.end_date }}
              <div class="input-icon">
                <i class="fas fa-calendar-alt"></i>
              </div>
            </div>
            {% if form.end_date.help_text %}
            <small class="form-help">{{ form.end_date.help_text }}</small>
            {% endif %}
            {% if form.end_date.errors %}
            <div class="error-messages">
              {% for error in form.end_date.errors %}
              <span class="error-message">{{ error }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>

          <!-- Contract Duration Field -->
          <div class="form-group {% if form.contract_duration.errors %}has-error{% endif %}">
            <label for="{{ form.contract_duration.id_for_label }}" class="form-label">
              <span class="label-text">
                <i class="fas fa-calendar-day"></i>
                مدة العقد
              </span>
            </label>
            <div class="input-group">
              {{ form.contract_duration }}
              <div class="input-icon">
                <i class="fas fa-clock"></i>
              </div>
            </div>
            {% if form.contract_duration.help_text %}
            <small class="form-help">{{ form.contract_duration.help_text }}</small>
            {% endif %}
            {% if form.contract_duration.errors %}
            <div class="error-messages">
              {% for error in form.contract_duration.errors %}
              <span class="error-message">{{ error }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>

          <!-- Site Published Field -->
          <div class="form-group {% if form.site_puplished.errors %}has-error{% endif %}">
            <label for="{{ form.site_puplished.id_for_label }}" class="form-label">
              <span class="label-text">
                <i class="fas fa-satellite-dish"></i>
                الموقع المنشور عليه
              </span>
            </label>
            <div class="input-group">
              {{ form.site_puplished }}
              <div class="input-icon">
                <i class="fas fa-sitemap"></i>
              </div>
            </div>
            {% if form.site_puplished.help_text %}
            <small class="form-help">{{ form.site_puplished.help_text }}</small>
            {% endif %}
            {% if form.site_puplished.errors %}
            <div class="error-messages">
              {% for error in form.site_puplished.errors %}
              <span class="error-message">{{ error }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Financial Information -->
      <div class="form-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-money-bill-wave"></i>
            المعلومات المالية
          </h2>
          <p class="section-description">التفاصيل المالية للشركة</p>
        </div>
        
        <div class="form-grid">
          <!-- Amount Paid Field -->
          <div class="form-group {% if form.amount_paid.errors %}has-error{% endif %}">
            <label for="{{ form.amount_paid.id_for_label }}" class="form-label">
              <span class="label-text">
                <i class="fas fa-money-bill"></i>
                المبلغ المدفوع
              </span>
            </label>
            <div class="input-group">
              {{ form.amount_paid }}
              <div class="input-icon">
                <i class="fas fa-dollar-sign"></i>
              </div>
            </div>
            {% if form.amount_paid.help_text %}
            <small class="form-help">{{ form.amount_paid.help_text }}</small>
            {% endif %}
            {% if form.amount_paid.errors %}
            <div class="error-messages">
              {% for error in form.amount_paid.errors %}
              <span class="error-message">{{ error }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>

          <!-- Contract Details Field -->
          <div class="form-group {% if form.contract_details.errors %}has-error{% endif %}">
            <label for="{{ form.contract_details.id_for_label }}" class="form-label">
              <span class="label-text">
                <i class="fas fa-file-contract"></i>
                تفاصيل العقد
              </span>
            </label>
            <div class="input-group">
              {{ form.contract_details }}
              <div class="input-icon">
                <i class="fas fa-clipboard-list"></i>
              </div>
            </div>
            {% if form.contract_details.help_text %}
            <small class="form-help">{{ form.contract_details.help_text }}</small>
            {% endif %}
            {% if form.contract_details.errors %}
            <div class="error-messages">
              {% for error in form.contract_details.errors %}
              <span class="error-message">{{ error }}</span>
              {% endfor %}
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Notes Section -->
      <div class="form-section">
        <div class="section-header">
          <h2 class="section-title">
            <i class="fas fa-sticky-note"></i>
            الملاحظات
          </h2>
          <p class="section-description">ملاحظات إضافية عن الشركة</p>
        </div>
        
        <div class="form-grid">
          <!-- Notes Field -->
          <div class="form-group full-width {% if form.nots.errors %}has-error{% endif %}">
            <label for="{{ form.nots.id_for_label }}" class="form-label">
              <span class="label-text">
                <i class="fas fa-edit"></i>
                ملاحظات
              </span>
            </label>
            <div class="input-group">
              {{ form.nots }}
              <div class="input-icon textarea-icon">
                <i class="fas fa-align-left"></i>
              </div>
            </div>
            {% if form.nots.help_text %}
            <small class="form-help">{{ form.nots.help_text }}</small>
            {% endif %}
            {% if form.nots.errors %}
            <div class="error-messages">
              {% for error in form.nots.errors %}
              <span class="error-message">{{ error }}</span>
              {% endfor %}
            </div>
            {% endif %}
            <div class="character-count">
              <span id="notes-char-count">{{ form.nots.value|length|default:0 }}</span> / 5000 حرف
            </div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <div class="action-buttons">
          <button type="reset" class="btn btn-secondary">
            <i class="fas fa-redo"></i>
            إعادة تعيين النموذج
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i>
            حفظ التعديلات
          </button>
          <a href="{% url 'company_list' %}" class="btn btn-outline">
            <i class="fas fa-times"></i>
            إلغاء والعودة
          </a>
          <button type="button" class="btn btn-danger" onclick="confirmDelete()">
            <i class="fas fa-trash"></i>
            حذف الشركة
          </button>
        </div>
        <div class="form-info">
          <i class="fas fa-info-circle"></i>
          تاريخ الإضافة: {{ company.created_at|date:"Y/m/d H:i" }}
        </div>
      </div>
    </form>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="deleteModal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">تأكيد حذف الشركة</h3>
        <button type="button" class="btn-close" onclick="hideDeleteModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="warning-icon">
          <i class="fas fa-exclamation-triangle"></i>
        </div>
        <p class="warning-text">
          هل أنت متأكد من حذف شركة <strong>"{{ company.name }}"</strong>؟
        </p>
        <div class="warning-details">
          <p><i class="fas fa-exclamation-circle"></i> هذا الإجراء لا يمكن التراجع عنه</p>
          <p><i class="fas fa-database"></i> سيتم حذف جميع بيانات الشركة</p>
          <p><i class="fas fa-history"></i> تمت الإضافة في: {{ company.created_at|date:"Y/m/d" }}</p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="hideDeleteModal()">
          <i class="fas fa-times"></i>
          إلغاء
        </button>
        <form method="POST" action="{% url 'company_delete' company.id %}" class="delete-form">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            <i class="fas fa-trash"></i>
            تأكيد الحذف
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Help Tips -->
  <div class="help-tips">
    <h3 class="tips-title">
      <i class="fas fa-lightbulb"></i>
      نصائح للتعديل
    </h3>
    <div class="tips-grid">
      <div class="tip-card">
        <div class="tip-icon">
          <i class="fas fa-save"></i>
        </div>
        <div class="tip-content">
          <h4>حفظ التعديلات</h4>
          <p>تأكد من حفظ التعديلات بعد الانتهاء</p>
        </div>
      </div>
      <div class="tip-card">
        <div class="tip-icon">
          <i class="fas fa-history"></i>
        </div>
        <div class="tip-content">
          <h4>تاريخ الإضافة</h4>
          <p>تاريخ إضافة الشركة لا يمكن تعديله</p>
        </div>
      </div>
      <div class="tip-card">
        <div class="tip-icon">
          <i class="fas fa-trash-alt"></i>
        </div>
        <div class="tip-content">
          <h4>الحذف الحذر</h4>
          <p>يمكنك حذف الشركة باستخدام الزر الأحمر</p>
        </div>
      </div>
      <div class="tip-card">
        <div class="tip-icon">
          <i class="fas fa-undo"></i>
        </div>
        <div class="tip-content">
          <h4>التراجع عن التغييرات</h4>
          <p>استخدم زر "إعادة تعيين" للتراجع عن التغييرات</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>
<script>
  // Initialize date picker
  document.addEventListener('DOMContentLoaded', function() {
    // End date picker
    const endDateInput = document.getElementById('{{ form.end_date.id_for_label }}');
    if (endDateInput) {
      flatpickr(endDateInput, {
        locale: "ar",
        dateFormat: "Y-m-d",
        allowInput: true,
        altInput: true,
        altFormat: "Y/m/d",
        minDate: "today",
      });
    }

    // Character count for notes
    const notesTextarea = document.getElementById('{{ form.nots.id_for_label }}');
    const charCountElement = document.getElementById('notes-char-count');
    
    if (notesTextarea && charCountElement) {
      function updateCharCount() {
        const count = notesTextarea.value.length;
        charCountElement.textContent = count;
        
        if (count > 5000) {
          charCountElement.style.color = '#e74c3c';
        } else if (count > 4000) {
          charCountElement.style.color = '#f39c12';
        } else {
          charCountElement.style.color = '#27ae60';
        }
      }
      
      notesTextarea.addEventListener('input', updateCharCount);
      updateCharCount(); // Initial count
    }

    // Close message buttons
    document.querySelectorAll('.close-message').forEach(button => {
      button.addEventListener('click', function() {
        this.closest('.message').style.display = 'none';
      });
    });

    // Auto-hide success messages after 5 seconds
    setTimeout(() => {
      document.querySelectorAll('.message.alert-success').forEach(message => {
        message.style.opacity = '0';
        setTimeout(() => {
          message.style.display = 'none';
        }, 300);
      });
    }, 5000);

    // Form validation
    const form = document.getElementById('editCompanyForm');
    form.addEventListener('submit', function(e) {
      const nameField = document.getElementById('{{ form.name.id_for_label }}');
      const emailField = document.getElementById('{{ form.email.id_for_label }}');
      
      let isValid = true;
      
      // Validate required fields
      if (!nameField.value.trim()) {
        showFieldError(nameField, 'يرجى إدخال اسم الشركة');
        isValid = false;
      }
      
      if (!emailField.value.trim()) {
        showFieldError(emailField, 'يرجى إدخال عنوان الشركة');
        isValid = false;
      }
      
      if (!isValid) {
        e.preventDefault();
        showAlert('error', 'يرجى تعبئة الحقول المطلوبة');
      }
    });

    function showFieldError(field, message) {
      const formGroup = field.closest('.form-group');
      if (!formGroup.querySelector('.error-message')) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-messages';
        errorDiv.innerHTML = `<span class="error-message">${message}</span>`;
        formGroup.appendChild(errorDiv);
        formGroup.classList.add('has-error');
      }
    }

    function showAlert(type, message) {
      const messagesContainer = document.querySelector('.messages-container') || 
        document.querySelector('.form-card').insertBefore(
          document.createElement('div'), 
          document.querySelector('.form-card').firstChild
        );
      
      const alertDiv = document.createElement('div');
      alertDiv.className = `message alert-${type}`;
      alertDiv.innerHTML = `
        <div class="message-icon">
          <i class="fas fa-exclamation-circle"></i>
        </div>
        <div class="message-content">
          <p>${message}</p>
        </div>
        <button type="button" class="close-message">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      messagesContainer.appendChild(alertDiv);
      
      // Add click event to close button
      alertDiv.querySelector('.close-message').addEventListener('click', function() {
        alertDiv.style.display = 'none';
      });
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => {
          alertDiv.style.display = 'none';
        }, 300);
      }, 5000);
    }

    // Clear error when user starts typing
    document.querySelectorAll('input, textarea, select').forEach(field => {
      field.addEventListener('input', function() {
        const formGroup = this.closest('.form-group');
        if (formGroup.classList.contains('has-error')) {
          const errorMessages = formGroup.querySelector('.error-messages');
          if (errorMessages) {
            errorMessages.remove();
          }
          formGroup.classList.remove('has-error');
        }
      });
    });
    
    // Auto-close on success
    {% if messages %}
      {% for message in messages %}
        {% if message.tags == 'success' %}
          // Start countdown for auto-close
          let countdown = 3;
          const countdownInterval = setInterval(() => {
            countdown--;
            
            if (countdown <= 0) {
              clearInterval(countdownInterval);
              closeAndReturn();
            }
          }, 1000);
          
          // Add close button and countdown message
          const formActions = document.querySelector('.form-actions');
          if (formActions) {
            // Add countdown message
            const countdownMsg = document.createElement('div');
            countdownMsg.className = 'auto-close-message';
            countdownMsg.innerHTML = `
              <i class="fas fa-clock"></i>
              <span>سيتم العودة للقائمة خلال <span id="autoCloseCountdown">${countdown}</span> ثوانٍ</span>
              <button class="btn-close-now" onclick="closeAndReturn()">
                <i class="fas fa-times"></i>
                إغلاق الآن
              </button>
            `;
            formActions.parentNode.insertBefore(countdownMsg, formActions);
            
            // Update countdown
            const countdownElement = document.getElementById('autoCloseCountdown');
            setInterval(() => {
              countdown--;
              if (countdownElement) {
                countdownElement.textContent = countdown;
              }
              
              if (countdown <= 0) {
                clearInterval(countdownInterval);
                closeAndReturn();
              }
            }, 1000);
          }
        {% endif %}
      {% endfor %}
    {% endif %}
  });

  // Function to show delete confirmation modal
  function confirmDelete() {
    const modal = document.getElementById('deleteModal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  // Function to hide delete modal
  function hideDeleteModal() {
    const modal = document.getElementById('deleteModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }

  // Close modal when clicking outside
  document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
      hideDeleteModal();
    }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      hideDeleteModal();
    }
  });

  // Function to close and return to list
  function closeAndReturn() {
    try {
      // If opened from popup
      if (window.opener && !window.opener.closed) {
        window.opener.location.reload();
        window.close();
      } else {
        // Normal window
        window.location.href = "{% url 'company_list' %}";
      }
    } catch (error) {
      // Fallback
      window.location.href = "{% url 'company_list' %}";
    }
  }
</script>
{% endblock %}