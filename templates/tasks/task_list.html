{% extends 'base.html' %}
{% load static %}


{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/tasks.css' %}">
  <link rel="stylesheet" href="{% static 'css/notifications.css' %}">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <title>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</title>
  <meta name="title" content="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…">
  <meta name="description" content="Ø§Ø³ØªØ¹Ø±Ø¶ ÙˆÙ‚Ù… Ø¨Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… ÙÙŠ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù…. ÙˆÙØ± Ø§Ù„ÙˆÙ‚Øª ÙˆÙ†Ø¸Ù… Ø¹Ù…Ù„Ùƒ Ø¨ÙƒÙØ§Ø¡Ø© Ø¹Ø§Ù„ÙŠØ© Ù…Ù† Ø®Ù„Ø§Ù„ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø³Ù‡Ù„Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….">
{% endblock %}
  
{% block content %}
<div class="task-container">
  <h1>ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù…</h1>

  <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ -->
  <div class="user-info">
    ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ: <strong>{{ request.user.username }}</strong> |
    ğŸ›¡ï¸ Ø§Ù„Ø¯ÙˆØ±: <strong>{{ request.user.role }}</strong>
  </div>

  <form method="get" class="task-filter-form">
    <label>
      Ø¨Ø­Ø«:
      <input type="text" name="q" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù†ÙˆØ§Ù† Ø£Ùˆ ÙƒØ§ØªØ¨..." value="{{ search_query|default:'' }}">
    </label>
    <label>
      Ø§Ù„ÙƒØ§ØªØ¨:
      <select name="writer">
        <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
        {% for id, name in writers %}
          <option value="{{ id }}" {% if id|stringformat:"s" == selected_writer|stringformat:"s" %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
    </label>

    <label>
      Ø§Ù„Ø­Ø§Ù„Ø©:
      <select name="status">
        <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
        <option value="in_progress" {% if selected_status == "in_progress" %}selected{% endif %}>â³ Ø¬Ø§Ø±ÙŠ</option>
        <option value="upload" {% if selected_status == "upload" %}selected{% endif %}>ğŸ“¤ ØªÙ… Ø§Ù„Ø±ÙØ¹</option>
        <option value="publish" {% if selected_status == "publish" %}selected{% endif %}>ğŸ“¢ ØªÙ… Ø§Ù„Ù†Ø´Ø±</option>
        <option value="done" {% if selected_status == "done" %}selected{% endif %}>âœ… Ù…ÙƒØªÙ…Ù„Ø©</option>
      </select>
    </label>

    <label>
      Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù†Ø´Ø±:
      <select name="site">
        <option value="">-- Ø§Ù„ÙƒÙ„ --</option>
        {% for id, name in sites %}
          <option value="{{ id }}" {% if id|stringformat:"s" == selected_site %}selected{% endif %}>{{ name }}</option>
        {% endfor %}
      </select>
    </label>

    <button type="submit">ğŸ” ØªØµÙÙŠØ©</button>
    <a href="{% url 'task_list' %}" class="reset-filter">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</a>
  </form>

  <div class="task-table-container">
    <table class="task-table">
      <thead>
        <tr>
          <th>Ø§Ù„ÙƒØ§ØªØ¨</th>
          <th>[Ø§Ù„Ù†ÙˆØ¹]</th>
          <th>Ø§Ù„Ù…Ù‚Ø§Ù„</th>
          <th>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù‚Ø§Ù„</th>
          <th>Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù‚Ø§Ù„</th>
          <th>Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù†Ø´Ø±</th>
          <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          <th>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</th>
        </tr>
      </thead>
      <tbody>
        {% for task in page_obj %}
        <tr>
          <td>{{ task.writer.get_full_name|default:task.writer.username }}</td>
          <td>{{ task.article_type_W_R_A_B }}</td>
          <td>{{ task.article_title }}</td>
          <td>{{ task.article_details }}</td>
          <td>
            {% if task.article_link %}
              <a href="{{ task.article_link }}" target="_blank">Ø§Ù„Ø±Ø§Ø¨Ø·</a>
            {% else %}
              <span style="color: gray;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø·</span>
            {% endif %}
          </td>
          <td>{{ task.publish_site }}</td>
          <td>{{ task.publish_date }}</td>
          <td>
            <form method="post" action="{% url 'update_task_status' task.id %}">
              {% csrf_token %}
              <select name="status" onchange="this.form.submit()" class="status-select">
                <option value="in_progress" {% if task.status == 'in_progress' %}selected{% endif %}>â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„</option>
                <option value="upload" {% if task.status == 'upload' %}selected{% endif %}>ğŸ“¤ ØªÙ… Ø§Ù„Ø±ÙØ¹</option>
                <option value="publish" {% if task.status == 'publish' %}selected{% endif %}>ğŸ“¢ ØªÙ… Ø§Ù„Ù†Ø´Ø±</option>
                <option value="done" {% if task.status == 'done' %}selected{% endif %}>âœ… Ù…ÙƒØªÙ…Ù„Ø©</option>
              </select>
            </form>
          </td>
          <td>
            {% if request.user.role == "manager" %}
              <a href="{% url 'edit_task' task.id %}" class="action-btn edit-btn">âœï¸ ØªØ¹Ø¯ÙŠÙ„</a>
              <a href="{% url 'delete_task' task.id %}" class="action-btn delete-btn" onclick="return confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ');">ğŸ—‘ï¸ Ø­Ø°Ù</a>
            {% else %}
              <span style="color: #6c757d;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙ„Ø§Ø­ÙŠØ©</span>
            {% endif %}
          </td>
          <td>
            <a href="#" onclick="openTaskDetails('{{ task.id }}'); return false;" class="action-btn view-btn">ğŸ‘ï¸ Ø¹Ø±Ø¶</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Ø§Ù„Ø¨Ø§Ø¬ÙŠÙ†Ø§Ø´Ù† -->
<div class="pagination">
  {% if page_obj.has_previous %}
    <a href="?page=1
      {% if search_query %}&q={{ search_query }}{% endif %}
      {% if selected_writer %}&writer={{ selected_writer }}{% endif %}
      {% if selected_status %}&status={{ selected_status }}{% endif %}
      {% if selected_site %}&site={{ selected_site }}{% endif %}
    ">Ø§Ù„Ø£ÙˆÙ„Ù‰</a>

    <a href="?page={{ page_obj.previous_page_number }}
      {% if search_query %}&q={{ search_query }}{% endif %}
      {% if selected_writer %}&writer={{ selected_writer }}{% endif %}
      {% if selected_status %}&status={{ selected_status }}{% endif %}
      {% if selected_site %}&site={{ selected_site }}{% endif %}
    ">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
  {% endif %}

  <span>ØµÙØ­Ø© {{ page_obj.number }} Ù…Ù† {{ page_obj.paginator.num_pages }}</span>

  {% if page_obj.has_next %}
    <a href="?page={{ page_obj.next_page_number }}
      {% if search_query %}&q={{ search_query }}{% endif %}
      {% if selected_writer %}&writer={{ selected_writer }}{% endif %}
      {% if selected_status %}&status={{ selected_status }}{% endif %}
      {% if selected_site %}&site={{ selected_site }}{% endif %}
    ">Ø§Ù„ØªØ§Ù„ÙŠ</a>

    <a href="?page={{ page_obj.paginator.num_pages }}
      {% if search_query %}&q={{ search_query }}{% endif %}
      {% if selected_writer %}&writer={{ selected_writer }}{% endif %}
      {% if selected_status %}&status={{ selected_status }}{% endif %}
      {% if selected_site %}&site={{ selected_site }}{% endif %}
    ">Ø§Ù„Ø£Ø®ÙŠØ±Ø©</a>
  {% endif %}
</div>


  {% if request.user.role == "manager" and form %}
    <div class="task-form-container">
      <h2>â• {% if edit_mode %}ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‡Ù…Ø©{% else %}Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©{% endif %}</h2>
      <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">{% if edit_mode %}ØªØ­Ø¯ÙŠØ«{% else %}Ø¥Ø¶Ø§ÙØ©{% endif %}</button>
      </form>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/task_popup.js' %}"></script>
  <script src="{% static 'js/notifications.js' %}"></script>
{% endblock %}