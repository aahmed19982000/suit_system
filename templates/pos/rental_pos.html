{% extends 'base.html' %}
{% load static %}

{% block title %}POS ูุชุฃุฌูุฑ ุงูุจุฏู - ูุฑูู ูุฑูุฏู{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pos.css' %}">
{% endblock %}

{% block content %}
<div class="pos-wrapper">
    <section class="products-section">
        <header class="pos-top-bar">
            <h2>ุงูุจุฏู ุงููุชุงุญุฉ ููุฅูุฌุงุฑ</h2>
            <button class="btn-top-action btn-rental-trigger" onclick="openRentalModal()">๐ ุชุฃุฌูุฑ ุจุฏูุฉ</button>
        </header>
    
        <div class="products-grid">
            {% for product in products %}
                <div class="product-card">
                    <div class="product-icon">๐</div>
                    <h4 class="product-name">{{ product.name }}</h4>
                    <p class="product-qty">ุงููุชุงุญ: {{ product.quantity }}</p>
    
                    <button class="btn-rent"
                            onclick="openRentalModal({{ product.id }})">
                        ุชุฃุฌูุฑ
                    </button>
                </div>
            {% empty %}
                <p class="no-products">ูุง ุชูุฌุฏ ุจุฏู ูุชุงุญุฉ ููุฅูุฌุงุฑ</p>
            {% endfor %}
        </div>
    </section>
    

    <aside class="cart-sidebar">
        <div class="cart-items-container" id="cartItemsContainer">ุงูุณูุฉ ูุงุฑุบุฉ</div>
        <button class="check-btn" onclick="submitRental()">ุชุฃููุฏ ุงูุชุฃุฌูุฑ ๐จ๏ธ</button>
    </aside>
</div>

<!-- ููุฏุงู ุงูุชุฃุฌูุฑ -->
<div id="rentalModal" class="custom-modal">
    <div class="modal-content">
        <h3>ุชุณุฌูู ุญุฌุฒ ุชุฃุฌูุฑ</h3>

        <label>ุงุฎุชุฑ ุงูุนููู:</label>
        <select id="customerSelect" class="input-field">
            {% for customer in customers %}
                <option value="{{ customer.id }}">{{ customer.name }} - {{ customer.phone }}</option>
            {% endfor %}
        </select>

        <label>ุงุฎุชุฑ ุงูุจุฏูุฉ:</label>
        <select id="itemSelect" class="input-field">
            {% for product in products %}
                <option value="{{ product.id }}">{{ product.name }} ({{ product.quantity }} ูุชุงุญุฉ)</option>
            {% endfor %}
        </select>

        <label>ุชุงุฑูุฎ ุงูุญุฌุฒ/ุงูุฎุฑูุฌ:</label>
        <input type="date" id="rentalDate" class="input-field" value="{{ today|default:None }}">

        <label>ุชุงุฑูุฎ ุงูุนูุฏุฉ ุงููุชููุน:</label>
        <input type="date" id="returnDate" class="input-field">

        <label>ุณุนุฑ ุงูุฅูุฌุงุฑ:</label>
        <input type="number" id="totalPrice" class="input-field">

        <label>ุงูุชุฃููู:</label>
        <input type="number" id="deposit" class="input-field">

        <label>ููุงุญุธุงุช:</label>
        <textarea id="notes" class="input-field" placeholder="ููุงุณุงุชุ ุชุนุฏููุงุช..."></textarea>

        <button class="modal-btn btn-confirm" onclick="closeRentalModal()">ุชู</button>
    </div>
</div>

<script>
    /* ูุชุญ ุงูููุฏุงู
       ูู ุงุชุจุนุช itemId โ ูุญุฏุฏ ุงูุจุฏูุฉ ุชููุงุฆู
       ูู ูุง โ ููุชุญ ุนุงุฏู ุฒู ูุจู */
    function openRentalModal(itemId = null) {
        document.getElementById('rentalModal').style.display = 'flex';
    
        if (itemId !== null) {
            const itemSelect = document.getElementById('itemSelect');
            itemSelect.value = itemId;
        }
    }
    
    function closeRentalModal() {
        document.getElementById('rentalModal').style.display = 'none';
    }
    
    function submitRental() {
        const data = {
            customer_id: document.getElementById('customerSelect').value,
            item_id: document.getElementById('itemSelect').value,
            rental_date: document.getElementById('rentalDate').value,
            return_date: document.getElementById('returnDate').value,
            total_price: document.getElementById('totalPrice').value,
            deposit: document.getElementById('deposit').value,
            notes: document.getElementById('notes').value
        };
    
        if (
            !data.customer_id ||
            !data.item_id ||
            !data.total_price ||
            !data.rental_date ||
            !data.return_date
        ) {
            alert("ุงููู ุฌููุน ุงูุจูุงูุงุช ุงููุทููุจุฉ");
            return;
        }
    
        fetch("{% url 'rental_checkout' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(data)
        })
        .then(res => res.json())
        .then(resp => {
            if (resp.status === 'success') {
                alert('ุชู ุชุณุฌูู ุงูุชุฃุฌูุฑ');
                location.reload();
            } else {
                alert('ุญุตู ุฎุทุฃุ ุญุงูู ูุฑุฉ ุฃุฎุฑู');
            }
        })
        .catch(() => {
            alert('ุญุตู ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ');
        });
    }
    </script>
    
{% endblock %}
