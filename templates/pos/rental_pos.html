{% extends 'base.html' %}
{% load static %}

{% block title %}Ù†Ø¸Ø§Ù… POS - ÙƒÙ€Ø±ÙŠÙ… Ù‡Ù€Ø±ÙŠØ¯ÙŠ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pos_rental.css' %}">
<style>
    /* ØªØ­Ø³ÙŠÙ†Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ */
    .modal-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        backdrop-filter: blur(5px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .modal-overlay.active { display: flex; animation: fadeIn 0.3s ease; }
    .quick-add-customer { display: none; margin-top: 10px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; }
    .quick-add-customer.active { display: block; animation: slideDown 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
</style>
{% endblock %}

{% block content %}
<div class="pos-wrapper">
    <section class="products-section">
        <header class="pos-top-bar">
            <div class="title-area">
                <h2><i class="fas fa-suit"></i> Ø§Ù„Ø¨Ø¯Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
                <span class="badge" id="productCount">{{ products|length }} ØµÙ†Ù</span>
            </div>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="posSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¨Ø¯Ù„Ø©..." onkeyup="filterItems()">
            </div>
        </header>

        <div class="products-layout" id="productsGrid">
            {% for product in products %}
                <div class="product-item" data-name="{{ product.name|lower }}" onclick="openModal({{ product.id }})">
                    <div class="product-status {% if product.quantity > 0 %}instock{% else %}outofstock{% endif %}"></div>
                    <div class="product-icon">ğŸ‘”</div>
                    <div class="product-info">
                        <span class="product-title">{{ product.name }}</span>
                        <span class="product-qty">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: <strong>{{ product.quantity }}</strong></span>
                    </div>
                    <button class="btn-quick-rent"><i class="fas fa-plus"></i></button>
                </div>
            {% empty %}
                <div class="cart-empty-state" style="grid-column: 1/-1;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>
            {% endfor %}
        </div>
    </section>

    <aside class="cart-sidebar">
        <div class="cart-header">
            <h3><i class="fas fa-clipboard-check"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3>
        </div>
        <div class="cart-content-area">
            <div class="empty-notif">
                <i class="fas fa-tshirt" style="font-size: 3rem; color: var(--accent-gold); opacity: 0.3;"></i>
                <p>Ù‚Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø¯Ù„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¨Ø¯Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²</p>
            </div>
        </div>
        <button class="check-btn" onclick="openModal()">
            <i class="fas fa-plus-circle"></i> Ø­Ø¬Ø² ÙŠØ¯ÙˆÙŠ Ø¬Ø¯ÙŠØ¯
        </button>
    </aside>
</div>

<div id="rentalModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-file-invoice-dollar"></i> ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© ØªØ£Ø¬ÙŠØ±</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="form-group">
                <label>Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
                <div class="input-flex">
                    <select id="customerSelect" class="input-field">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† --</option>
                        {% for customer in customers %}
                            <option value="{{ customer.id }}">{{ customer.name }} ({{ customer.phone }})</option>
                        {% endfor %}
                    </select>
                    <button class="add-btn" onclick="toggleNewCustomer()" title="Ø¥Ø¶Ø§ÙØ© Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯">+</button>
                </div>
            </div>

            <div id="newCustomerForm" class="quick-add-customer">
                <div class="form-row">
                    <input type="text" id="ncName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯" class="input-field">
                    <input type="text" id="ncPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" class="input-field">
                </div>
                <button class="btn-save-customer" onclick="createNewCustomer()">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
            </div>

            <div class="form-group">
                <label>Ø§Ù„Ø¨Ø¯Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:</label>
                <select id="itemSelect" class="input-field">
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø¯Ù„Ø© --</option>
                    {% for product in products %}
                        <option value="{{ product.id }}">{{ product.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø±ÙˆØ¬:</label>
                    <input type="date" id="rDate" class="input-field" value="{% now 'Y-m-d' %}">
                </div>
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹ÙˆØ¯Ø©:</label>
                    <input type="date" id="retDate" class="input-field">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±:</label>
                    <input type="number" id="tPrice" class="input-field" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Ù…Ø¨Ù„Øº Ø§Ù„ØªØ£Ù…ÙŠÙ†:</label>
                    <input type="number" id="tDeposit" class="input-field" placeholder="0.00">
                </div>
            </div>

            <div class="form-group">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª ÙˆØ§Ù„Ù…Ù‚Ø§Ø³Ø§Øª:</label>
                <textarea id="rNotes" class="input-field" style="height: 80px; resize: none;" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ù†Ø§ (Ù…Ø«Ù„Ø§Ù‹: ØªÙ‚ØµÙŠØ± Ø§Ù„ÙƒÙ…ØŒ ØªØ¶ÙŠÙŠÙ‚ Ø§Ù„ÙˆØ³Ø·)..."></textarea>
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-confirm-modal" id="submitBtn" onclick="submitBooking()">
                <span>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ·Ø¨Ø§Ø¹Ø©</span> <i class="fas fa-print"></i>
            </button>
        </div>
    </div>
</div>

<script>
    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© (Modal) ---
    function openModal(id = null) {
        const modal = document.getElementById('rentalModal');
        modal.classList.add('active');
        if(id) document.getElementById('itemSelect').value = id;
    }

    function closeModal() {
        document.getElementById('rentalModal').classList.remove('active');
        document.getElementById('newCustomerForm').classList.remove('active');
    }

    function toggleNewCustomer() {
        document.getElementById('newCustomerForm').classList.toggle('active');
    }

    // --- ÙÙ„ØªØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ---
    function filterItems() {
        const q = document.getElementById('posSearch').value.toLowerCase();
        const items = document.querySelectorAll('.product-item');
        let count = 0;

        items.forEach(item => {
            const match = item.dataset.name.includes(q);
            item.style.display = match ? 'flex' : 'none';
            if(match) count++;
        });
        document.getElementById('productCount').innerText = `${count} ØµÙ†Ù`;
    }

    // --- Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù€ AJAX ---
    async function apiRequest(url, payload) {
        const res = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify(payload)
        });
        return res.json();
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
    async function createNewCustomer() {
        const name = document.getElementById('ncName').value;
        const phone = document.getElementById('ncPhone').value;
        const btn = event.target;

        if(!name || !phone) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„");

        btn.disabled = true;
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";

        try {
            const data = await apiRequest("{% url 'create_customer_ajax' %}", { name, phone });
            if(data.status === 'success') {
                const sel = document.getElementById('customerSelect');
                const opt = new Option(`${data.name} (${phone})`, data.id, true, true);
                sel.add(opt);
                toggleNewCustomer();
                document.getElementById('ncName').value = '';
                document.getElementById('ncPhone').value = '';
            }
        } catch (e) {
            alert("ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„");
        } finally {
            btn.disabled = false;
            btn.innerText = "Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„";
        }
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
    async function submitBooking() {
        const submitBtn = document.getElementById('submitBtn');
        const payload = {
            customer_id: document.getElementById('customerSelect').value,
            item_id: document.getElementById('itemSelect').value,
            rental_date: document.getElementById('rDate').value,
            return_date: document.getElementById('retDate').value,
            total_price: document.getElementById('tPrice').value,
            deposit: document.getElementById('tDeposit').value,
            notes: document.getElementById('rNotes').value,
        };

        if(!payload.customer_id || !payload.item_id || !payload.return_date) {
            return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ§Ù„Ø¨Ø¯Ù„Ø© ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹ÙˆØ¯Ø©");
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

        try {
            const data = await apiRequest("{% url 'rental_checkout' %}", payload);
            if(data.status === 'success') {
                alert('âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­');
                location.reload();
            } else {
                alert('âŒ Ø®Ø·Ø£: ' + (data.message || 'ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸'));
            }
        } catch (e) {
            alert("ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<span>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ·Ø¨Ø§Ø¹Ø©</span> <i class="fas fa-print"></i>';
        }
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø®Ø§Ø±Ø¬Ù‡
    window.onclick = function(e) {
        if (e.target.classList.contains('modal-overlay')) closeModal();
    }
</script>
{% endblock %}