{% extends 'base.html' %}
{% load static %}

{% block title %}Ù†Ø¸Ø§Ù… POS - ÙƒÙ€Ø±ÙŠÙ… Ù‡Ù€Ø±ÙŠØ¯ÙŠ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pos_rental.css' %}">
<style>
    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 1000;
        justify-content: center; align-items: center;
    }
    .modal-overlay.active { display: flex; animation: fadeIn 0.3s ease; }
    
    /* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ Ù„Ù„Ø³ÙƒØ±ÙˆÙ„ */
    .modal-content {
        max-height: 90vh; 
        overflow-y: auto; 
        background: #121212;
        padding: 25px;
        border-radius: 15px;
        scrollbar-width: thin;
        scrollbar-color: var(--accent-gold) #222;
    }
    .modal-content::-webkit-scrollbar { width: 6px; }
    .modal-content::-webkit-scrollbar-thumb { background: var(--accent-gold); border-radius: 10px; }

    .quick-add-customer { display: none; margin-top: 10px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; border-right: 3px solid var(--accent-gold); }
    .quick-add-customer.active { display: block; animation: slideDown 0.3s ease; }
    .feedback-msg { font-size: 0.85rem; margin-top: 5px; display: block; min-height: 20px; }
    
    /* ØªØ¹Ø¯ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„ØªØµØ¨Ø­ Ø£ÙƒØ«Ø± ØªÙ†Ø§Ø³Ù‚Ø§Ù‹ */
    .form-grid-custom { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 15px; }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .search-buttons { display: flex; gap: 10px; margin-top: 5px; }
    .btn-search-action { cursor: pointer; border: none; border-radius: 5px; transition: 0.3s; padding: 8px 15px; }
</style>
{% endblock %}

{% block content %}
<div class="pos-wrapper">
    <section class="products-section">
        <header class="pos-top-bar">
            <div class="title-area">
                <h2><i class="fas fa-suit"></i> Ø§Ù„Ø¨Ø¯Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
                <span class="badge" id="productCount">{{ products|length }} ØµÙ†Ù</span>
            </div>
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="posSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ ÙƒÙˆØ¯ UID..." onkeyup="filterItems()">
            </div>
        </header>

        <div class="products-layout" id="productsGrid">
            {% for product in products %}
                <div class="product-item" data-name="{{ product.name|lower }}" data-uid="{{ product.UID|default:'' }}" onclick="openModal('{{ product.UID }}')"> 
                    <div class="product-status {% if product.quantity > 0 %}instock{% else %}outofstock{% endif %}"></div>
                    <div class="product-icon">ğŸ‘”</div>
                    <div class="product-info">
                        <span class="product-title">{{ product.name }}</span>
                        <span class="product-qty"> Ø§Ù„ÙƒÙ…ÙŠØ©: <strong>{{ product.quantity }}</strong></span>
                    </div>
                    <button class="btn-quick-rent"><i class="fas fa-plus"></i></button>
                </div>
            {% endfor %}
        </div>
    </section>

    <aside class="cart-sidebar">
        <div class="cart-header"><h3><i class="fas fa-clipboard-check"></i> ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3></div>
        <div class="cart-content-area">
            <div class="empty-notif">
                <i class="fas fa-tshirt" style="font-size: 3rem; color: var(--accent-gold); opacity: 0.3;"></i>
                <p>Ù‚Ù… Ø¨Ø§Ø®ØªÙŠØ§Ø± Ø¨Ø¯Ù„Ø© Ø£Ùˆ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ø¨Ø¯Ø¡ Ø­Ø¬Ø² ÙŠØ¯ÙˆÙŠ</p>
            </div>
        </div>
        <button class="check-btn" onclick="openModal()"><i class="fas fa-plus-circle"></i> Ø­Ø¬Ø² ÙŠØ¯ÙˆÙŠ Ø¨Ø§Ù„Ù€ UID</button>
    </aside>
</div>

<div id="rentalModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 650px;">
        <div class="modal-header">
            <h3><i class="fas fa-file-invoice-dollar"></i> ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© ØªØ£Ø¬ÙŠØ±</h3>
            <button class="close-btn" onclick="closeModal()">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="form-group">
                <label>Ø±Ù‚Ù… Ù‡Ø§ØªÙ Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
                <input type="text" id="custPhone" class="input-field" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ...">
                <div class="search-buttons">
                    <button type="button" onclick="checkCustomer()" class="btn-search-action" style="background: var(--accent-gold); color: #000;">ğŸ” Ø¨Ø­Ø« Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
                </div>
                <small id="customerFeedback" class="feedback-msg"></small>
                <input type="hidden" id="selectedCustomerId">
            </div>

            <div id="newCustomerForm" class="quick-add-customer">
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label>
                    <input type="text" id="ncName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„" class="input-field">
                </div>
                <div class="form-group" style="margin-top: 10px;">
                    <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
                    <input type="text" id="ncAddress" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØªÙØµÙŠÙ„ÙŠ" class="input-field">
                </div>
            </div>

            <hr style="opacity: 0.1; margin: 15px 0;">

            <div class="form-grid-custom">
                <div class="form-group">
                    <label>ÙƒÙˆØ¯ UID:</label>
                    <input type="text" id="suitUID" class="input-field" placeholder="RENT-XXXX">
                    <button type="button" onclick="checkUID()" class="btn-search-action" style="margin-top:5px; width: 100%; background: #444; color: #fff; font-size: 0.8rem;">ğŸ” Ø¨Ø­Ø«</button>
                </div>
                <div class="form-group">
                    <label>Ù…Ù‚Ø§Ø³ Ø§Ù„Ø¬Ø§ÙƒÙŠØª:</label>
                    <select id="suitSize" class="input-field">
                        <option value="">-- Ø§Ø®ØªØ± --</option>
                        {% for s in sizes %} <option value="{{ s.id }}">{{ s.size }}</option> {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù„ÙˆÙ†:</label>
                    <select id="suitColor" class="input-field">
                        <option value="">-- Ø§Ø®ØªØ± --</option>
                        {% for c in colors %} <option value="{{ c.id }}">{{ c.color }}</option> {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Ù…Ù‚Ø§Ø³ Ø§Ù„Ø¨Ù†Ø·Ù„ÙˆÙ†:</label>
                    <input type="text" id="pantsSize" class="input-field" placeholder="ÙŠØ¯ÙˆÙŠ">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø±ÙˆØ¬:</label>
                    <input type="date" id="rDate" class="input-field" value="{% now 'Y-m-d' %}">
                </div>
                <div class="form-group">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹ÙˆØ¯Ø©:</label>
                    <input type="date" id="retDate" class="input-field">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥ÙŠØ¬Ø§Ø±:</label>
                    <input type="number" id="tPrice" class="input-field" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Ù…Ø¨Ù„Øº Ø§Ù„ØªØ£Ù…ÙŠÙ†:</label>
                    <input type="number" id="tDeposit" class="input-field" placeholder="0.00">
                </div>
            </div>

            <div class="form-group">
                <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª:</label>
                <textarea id="rNotes" class="input-field" style="height: 60px; resize: none;" placeholder="Ù…Ù‚Ø§Ø³Ø§ØªØŒ ØªÙ‚ØµÙŠØ±..."></textarea>
            </div>
            
            <small id="uidFeedback" class="feedback-msg" style="text-align: center;"></small>
        </div>

        <div class="modal-footer" style="margin-top: 20px;">
            <button class="btn-confirm-modal" id="submitBtn" onclick="submitBooking()" style="width: 100%; padding: 15px; background: var(--accent-gold); border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
                <span>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ­ÙØ¸</span> <i class="fas fa-check-circle"></i>
            </button>
        </div>
    </div>
</div>

<script>
// (Ø§Ù„Ø¯ÙˆØ§Ù„ checkCustomer, checkUID, openModal ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ)

async function checkCustomer() {
    const phone = document.getElementById('custPhone').value;
    const feedback = document.getElementById('customerFeedback');
    const newCustForm = document.getElementById('newCustomerForm');
    const hiddenId = document.getElementById('selectedCustomerId');
    if (!phone) { feedback.innerHTML = "âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù‡Ø§ØªÙ"; return; }
    try {
        feedback.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...";
        const res = await fetch("{% url 'search_customer' %}?phone=" + encodeURIComponent(phone));
        const data = await res.json();
        if (data.found) {
            feedback.innerHTML = `<b style="color: #28a745;">âœ… Ù…Ø³Ø¬Ù„: ${data.name}</b>`;
            hiddenId.value = data.id;
            document.getElementById('ncName').value = data.name;
            if(data.address) document.getElementById('ncAddress').value = data.address;
            newCustForm.classList.remove('active');
        } else {
            feedback.innerHTML = `<b style="color: #ffc107;">âš ï¸ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</b>`;
            hiddenId.value = "";
            document.getElementById('ncName').value = "";
            document.getElementById('ncAddress').value = "";
            newCustForm.classList.add('active');
        }
    } catch (e) { feedback.innerHTML = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„"; }
}

async function checkUID() {
    const uid = document.getElementById('suitUID').value;
    const feedback = document.getElementById('uidFeedback');
    if (!uid) { feedback.innerHTML = "âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ UID"; return; }
    try {
        feedback.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙØ­Øµ...";
        const res = await fetch("{% url 'search_UID' %}?uid=" + encodeURIComponent(uid));
        if (!res.ok) throw new Error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±');
        const data = await res.json();
        if (data.found) {
            feedback.innerHTML = `<b style="color: #28a745;">âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ±: ${data.name}</b>`;
            if(data.size) document.getElementById('suitSize').value = data.size;
            if(data.color) document.getElementById('suitColor').value = data.color;
        } else {
            feedback.innerHTML = `<b style="color: #dc3545;">âŒ ${data.message || 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}</b>`;
        }
    } catch(e) { feedback.innerHTML = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±"; }
}

function openModal(uid = '') {
    document.getElementById('rentalModal').classList.add('active');
    if (uid) { document.getElementById('suitUID').value = uid; checkUID(); }
}

function closeModal() {
    document.getElementById('rentalModal').classList.remove('active');
    ['custPhone','ncName','ncAddress','suitUID','suitSize','pantsSize','suitColor','tPrice','tDeposit','rNotes','retDate'].forEach(id => {
        const el = document.getElementById(id); if(el) el.value = "";
    });
    document.getElementById('customerFeedback').innerHTML = "";
    document.getElementById('uidFeedback').innerHTML = "";
    document.getElementById('newCustomerForm').classList.remove('active');
}

function filterItems() {
    const q = document.getElementById('posSearch').value.toLowerCase();
    document.querySelectorAll('.product-item').forEach(item => {
        const match = item.dataset.name.includes(q) || item.dataset.uid.toLowerCase().includes(q);
        item.style.display = match ? 'flex' : 'none';
    });
}

// Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡Ø§Ù… ÙÙŠ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸
async function submitBooking() {
    const submitBtn = document.getElementById('submitBtn');
    const payload = {
        customer_id: document.getElementById('selectedCustomerId').value,
        phone: document.getElementById('custPhone').value,
        customer_name: document.getElementById('ncName').value,
        customer_address: document.getElementById('ncAddress').value,
        uid: document.getElementById('suitUID').value,
        size_id: document.getElementById('suitSize').value,
        color_id: document.getElementById('suitColor').value,
        rental_date: document.getElementById('rDate').value,
        return_date: document.getElementById('retDate').value,
        total_price: document.getElementById('tPrice').value,
        deposit_amount: document.getElementById('tDeposit').value, // Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù…ÙˆØ¯ÙŠÙ„
        notes: document.getElementById('rNotes').value,
        pants_size: document.getElementById('pantsSize').value, // Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­ Ø¨Ø¯ÙˆÙ† ÙƒØ´ÙŠØ¯Ø©
    };

    if (!payload.phone || !payload.uid || !payload.return_date) {
        return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø§Ù„Ù‡Ø§ØªÙØŒ Ø§Ù„ÙƒÙˆØ¯ØŒ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹ÙˆØ¯Ø©)");
    }

    if (!payload.customer_id && (!payload.customer_name || !payload.customer_address)) {
        return alert("Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ø¬Ø¯Ø¯ØŒ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¹Ù†ÙˆØ§Ù†");
    }

    submitBtn.disabled = true;
    submitBtn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

    try {
        const res = await fetch("{% url 'rental_checkout' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.status === 'success') {
            alert('âœ… ' + data.message);
            location.reload();
        } else { 
            alert('âŒ ' + data.message); 
        }
    } catch (e) { 
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±"); 
    } finally { 
        submitBtn.disabled = false; 
        submitBtn.innerHTML = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ­ÙØ¸'; 
    }
}
</script>
{% endblock %}