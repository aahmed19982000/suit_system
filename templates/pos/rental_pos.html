{% extends 'base.html' %}
{% load static %}

{% block title %}POS Ù„ØªØ£Ø¬ÙŠØ± Ø§Ù„Ø¨Ø¯Ù„ - ÙƒØ±ÙŠÙ… Ù‡Ø±ÙŠØ¯ÙŠ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pos_rental.css' %}">
{% endblock %}

{% block content %}
<div class="pos-wrapper">
    <section class="products-section">
        <header class="pos-top-bar">
            <h2><i class="fas fa-suit"></i> Ø§Ù„Ø¨Ø¯Ù„ Ø§Ù„Ù…ØªØ§Ø­Ø©</h2>
            <input type="text" id="posSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø¨Ø¯Ù„Ø©..." onkeyup="filterItems()">
        </header>

        <div class="products-layout" id="productsGrid">
            {% for product in products %}
                <div class="product-item" data-name="{{ product.name|lower }}">
                    <div class="product-icon">ğŸ‘”</div>
                    <div class="product-title">{{ product.name }}</div>
                    <div class="product-qty">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: {{ product.quantity }}</div>
                    <button class="btn-rent-action" onclick="openModal({{ product.id }})">ØªØ£Ø¬ÙŠØ± Ø§Ù„Ø¨Ø¯Ù„Ø©</button>
                </div>
            {% empty %}
                <div class="cart-empty-state" style="grid-column: 1/-1;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…ØªØ§Ø­Ø©</div>
            {% endfor %}
        </div>
    </section>

    <aside class="cart-sidebar">
        <div class="cart-header">
            <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¬Ø²</h3>
        </div>
        <div class="cart-empty-state">
            <i class="fas fa-clipboard-list" style="font-size: 4rem; margin-bottom: 1rem;"></i>
            <p>Ø§Ø®ØªØ± Ø¨Ø¯Ù„Ø© Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ø¬Ø²</p>
        </div>
        <button class="check-btn" onclick="openModal()">+ Ø­Ø¬Ø² ÙŠØ¯ÙˆÙŠ Ø¬Ø¯ÙŠØ¯</button>
    </aside>
</div>

<div id="rentalModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="color: var(--accent-gold); margin-top: 0; margin-bottom: 20px;">ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© ØªØ£Ø¬ÙŠØ±</h3>
        
        <label>Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
        <div style="display: flex; gap: 8px;">
            <select id="customerSelect" class="input-field">
                <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ --</option>
                {% for customer in customers %}
                    <option value="{{ customer.id }}">{{ customer.name }} ({{ customer.phone }})</option>
                {% endfor %}
            </select>
            <button onclick="toggleNewCustomer()" style="height: 45px; width: 50px; background: var(--accent-gold); color: white; border: none; border-radius: 10px; cursor: pointer;">+</button>
        </div>

        <div id="newCustomerForm" class="quick-add-customer" style="display: none;">
            <input type="text" id="ncName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯" class="input-field">
            <input type="text" id="ncPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„" class="input-field">
            <button class="btn-confirm-modal" style="background: #27272a;" onclick="createNewCustomer()">Ø­ÙØ¸ Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
        </div>

        <label>Ø§Ù„Ø¨Ø¯Ù„Ø©:</label>
        <select id="itemSelect" class="input-field">
            {% for product in products %}
                <option value="{{ product.id }}">{{ product.name }}</option>
            {% endfor %}
        </select>

        <div class="form-row">
            <div>
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø®Ø±ÙˆØ¬:</label>
                <input type="date" id="rDate" class="input-field" value="{% now 'Y-m-d' %}">
            </div>
            <div>
                <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹ÙˆØ¯Ø©:</label>
                <input type="date" id="retDate" class="input-field">
            </div>
        </div>

        <div class="form-row">
            <div>
                <label>Ø§Ù„Ø³Ø¹Ø±:</label>
                <input type="number" id="tPrice" class="input-field" placeholder="0.00">
            </div>
            <div>
                <label>Ø§Ù„ØªØ£Ù…ÙŠÙ†:</label>
                <input type="number" id="tDeposit" class="input-field" placeholder="0.00">
            </div>
        </div>

        <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ù…Ù‚Ø§Ø³Ø§ØªØŒ ØªØ¹Ø¯ÙŠÙ„Ø§Øª):</label>
        <textarea id="rNotes" class="input-field" style="height: 70px; resize: none; padding: 10px;" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ù†Ø§..."></textarea>

        <button class="btn-confirm-modal" onclick="submitBooking()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ğŸ–¨ï¸</button>
        <button onclick="closeModal()" style="width: 100%; background: none; color: var(--text-muted); border: none; margin-top: 10px; cursor: pointer;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>

<script>
    function openModal(id = null) {
        document.getElementById('rentalModal').style.display = 'flex';
        if(id) document.getElementById('itemSelect').value = id;
    }

    function closeModal() {
        document.getElementById('rentalModal').style.display = 'none';
        document.getElementById('newCustomerForm').style.display = 'none';
    }

    function toggleNewCustomer() {
        const form = document.getElementById('newCustomerForm');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';
    }

    function filterItems() {
        const q = document.getElementById('posSearch').value.toLowerCase();
        document.querySelectorAll('.product-item').forEach(item => {
            item.style.display = item.dataset.name.includes(q) ? 'block' : 'none';
        });
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ AJAX
    async function createNewCustomer() {
        const name = document.getElementById('ncName').value;
        const phone = document.getElementById('ncPhone').value;
        if(!name || !phone) return alert("Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„");

        const res = await fetch("{% url 'create_customer_ajax' %}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify({ name, phone })
        });
        const data = await res.json();
        if(data.status === 'success') {
            const sel = document.getElementById('customerSelect');
            sel.add(new Option(data.name, data.id));
            sel.value = data.id;
            toggleNewCustomer();
        }
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø¬Ø² Ø¨ÙƒØ§ÙØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    async function submitBooking() {
        const payload = {
            customer_id: document.getElementById('customerSelect').value,
            item_id: document.getElementById('itemSelect').value,
            rental_date: document.getElementById('rDate').value,
            return_date: document.getElementById('retDate').value,
            total_price: document.getElementById('tPrice').value,
            deposit: document.getElementById('tDeposit').value,
            notes: document.getElementById('rNotes').value, // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
        };

        if(!payload.customer_id || !payload.item_id || !payload.return_date) {
            return alert("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ØŒ Ø§Ù„Ø¨Ø¯Ù„Ø©ØŒ ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø¹ÙˆØ¯Ø©");
        }

        const res = await fetch("{% url 'rental_checkout' %}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(data.status === 'success') {
            alert('ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­');
            location.reload();
        } else {
            alert('Ø®Ø·Ø£: ' + (data.message || 'Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸'));
        }
    }
</script>
{% endblock %}