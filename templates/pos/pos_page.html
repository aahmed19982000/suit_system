{% extends 'base.html' %}
{% load static %}

{% block title %}Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ - ÙØ·Ø§Ø·Ø±ÙŠ Ø§Ù„Ø¨Ø±ÙƒØ©{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pos.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø³Ù„Ø© ÙˆØ§Ù„ÙÙˆØªØ± */
    .cart-sidebar {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 20px);
        position: sticky;
        top: 10px;
    }

    #cartItemsContainer {
        flex: 1;
        overflow-y: auto;
        padding-right: 5px;
        min-height: 200px;
    }

    .btn-return-action {
        background-color: #f39c12;
        color: white !important;
        text-decoration: none;
        padding: 8px 15px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: bold;
        margin-left: 10px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modals) */
    .custom-modal {
        display: none; /* Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(3px);
    }
    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        width: 420px;
        direction: rtl;
        font-family: 'Cairo', sans-serif;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    .modal-btn {
        width: 100%;
        padding: 15px;
        margin: 10px 0;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 1.1rem;
        transition: 0.2s;
    }
    .btn-table { background: #27ae60; color: white; }
    .btn-delivery { background: #3498db; color: white; }
    .btn-search { background: #8e44ad; color: white; margin-bottom: 5px; }
    
    .input-field {
        width: 100%;
        padding: 12px;
        margin: 10px 0;
        border: 2px solid #eee;
        border-radius: 8px;
        font-family: 'Cairo';
        box-sizing: border-box;
    }
    .input-field:focus { border-color: #3498db; outline: none; }
</style>
{% endblock %}

{% block content %}
<div class="pos-wrapper">
    <section class="products-section">
        <header class="pos-top-bar">
            <div class="search-container">
                <i class="search-icon">ğŸ”</i>
                <input type="text" id="posSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù...">
            </div>
            <div class="user-actions">
                <a href="{% url 'orders' %}" class="btn-return-action">ğŸ”„ Ø¥Ø¶Ø§ÙØ© Ù…Ø±ØªØ¬Ø¹</a>
                <button class="action-circle">ğŸ””</button>
                <button class="action-circle">âš™ï¸</button>
            </div>
        </header>

        <nav class="categories-container">
            <div class="cat-track">
                <button class="cat-pill active" data-filter="all">â­ Ø§Ù„ÙƒÙ„</button>
                {% for category in categories %}
                    <button class="cat-pill" data-filter="{{ category.id }}">{{ category.name }}</button>
                {% endfor %}
            </div>
        </nav>

        <div class="products-layout" id="productsGrid">
            {% for item in products %} <div class="product-item" data-category="{{ item.category.id }}">
                <div class="product-main-info">
                    <h3 class="product-title">{{ item.name }}</h3>
                    <div class="product-price-tag">{{ item.unit_cost }} <span>Ø¬.Ù…</span></div>
                </div>
                <p class="product-desc">Ø§Ù„Ù…ØªØ§Ø­: {{ item.quantity }} {{ item.unit.name }}</p>
                <button class="add-to-cart-btn" 
                        data-id="{{ item.id }}" 
                        data-name="{{ item.name }}" 
                        data-price="{{ item.unit_cost }}"> Ø¥Ø¶Ø§ÙØ© + </button>
            </div>
            {% endfor %}
        </div>
    </section>

    <aside class="cart-sidebar">
        <div class="cart-header">
            <div class="cart-meta">
                <h2>Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
                <span class="order-id" id="displayOrderId">#ORD-Ø¬Ø¯ÙŠØ¯</span>
            </div>
            <button class="clear-cart" id="clearCart">ğŸ—‘ï¸</button>
        </div>

        <div class="cart-items-container" id="cartItemsContainer">
            <div class="empty-cart-msg">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>
        </div>

        <div class="cart-summary-footer">
            <div class="billing-details">
                <div class="bill-row"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ</span> <span id="subtotalDisplay">0.00 Ø¬.Ù…</span></div>
                <div class="bill-row"><span>Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© (0%)</span> <span id="taxDisplay">0.00 Ø¬.Ù…</span></div>
                <div class="bill-row grand-total"><span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</span> <span id="totalDisplay">0.00 Ø¬.Ù…</span></div>
            </div>

            <div class="checkout-grid">
                <button class="check-btn cash" id="cashCheckout">ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨ </button>
            </div>
        </div>
    </aside>
</div>

<div id="orderTypeModal" class="custom-modal">
    <div class="modal-content text-center" style="text-align: center;">
        <h3 style="margin-bottom: 20px;">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</h3>
        <button class="modal-btn btn-table" onclick="selectOrderType('table')">Ø¹Ù…ÙŠÙ„ ÙØ±Ø¹</button>
        <button class="modal-btn btn-delivery" onclick="selectOrderType('delivery')">ğŸ›µ Ø·Ù„Ø¨ Ø¯Ù„ÙŠÙØ±ÙŠ / ØªÙˆØµÙŠÙ„</button>
        <button onclick="closeModals()" style="background:none; border:none; color:#e74c3c; cursor:pointer; margin-top:10px;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</button>
    </div>
</div>

<div id="customerModal" class="custom-modal">
    <div class="modal-content">
        <h3 style="margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px;">Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¯Ù„ÙŠÙØ±ÙŠ</h3>
        
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>
        <div style="display: flex; gap: 5px;">
            <input type="text" id="custPhone" class="input-field" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…">
            <button class="modal-btn btn-search" style="width: 80px;" onclick="searchCustomer()">Ø¨Ø­Ø«</button>
        </div>

        <div id="customerDetailsForm" style="display:none; margin-top:10px;">
            <label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„:</label>
            <input type="text" id="custName" class="input-field" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„">
            <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„:</label>
            <textarea id="custAddress" class="input-field" style="height: 80px;" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†ØŒ Ø§Ù„Ø¯ÙˆØ±ØŒ Ø§Ù„Ø´Ù‚Ø©..."></textarea>
            
            <button class="modal-btn btn-table" style="margin-top: 15px;" onclick="finalizeOrder()">ØªØ£ÙƒÙŠØ¯ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ ğŸ–¨ï¸</button>
        </div>
        <button onclick="closeModals()" style="width:100%; background:none; border:none; color:gray; cursor:pointer;">Ø±Ø¬ÙˆØ¹</button>
    </div>
</div>

<script>
let cart = [];
let currentOrderType = 'table';

// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„Ø³Ù„Ø©
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('add-to-cart-btn')) {
        const btn = e.target;
        const product = { 
            id: btn.dataset.id, 
            name: btn.dataset.name, 
            price: parseFloat(btn.dataset.price), 
            qty: 1 
        };
        const existing = cart.find(item => item.id === product.id);
        if (existing) existing.qty++; else cart.push(product);
        renderCart();
    }
});

function renderCart() {
    const container = document.getElementById('cartItemsContainer');
    container.innerHTML = '';
    let subtotal = 0;
    if (cart.length === 0) container.innerHTML = '<div class="empty-cart-msg">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>';
    cart.forEach(item => {
        subtotal += (item.price * item.qty);
        container.innerHTML += `<div class="cart-card">
            <div class="cart-card-info"><h4>${item.name}</h4><div class="price-calc">${item.price} Ã— ${item.qty} = <strong>${(item.price * item.qty).toFixed(2)} Ø¬.Ù…</strong></div></div>
            <div class="cart-card-actions"><div class="stepper"><button onclick="updateQty('${item.id}', -1)">âˆ’</button><input type="number" value="${item.qty}" readonly><button onclick="updateQty('${item.id}', 1)">+</button></div></div>
        </div>`;
    });
    document.getElementById('subtotalDisplay').innerText = subtotal.toFixed(2) + ' Ø¬.Ù…';
    document.getElementById('totalDisplay').innerText = subtotal.toFixed(2) + ' Ø¬.Ù…';
}

window.updateQty = function(id, change) {
    const item = cart.find(i => i.id === id);
    if (item) { item.qty += change; if (item.qty <= 0) cart = cart.filter(i => i.id !== id); renderCart(); }
}

// ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†ÙˆØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ ÙƒØ§Ø´
document.getElementById('cashCheckout').onclick = () => {
    if (cart.length === 0) return alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©!');
    document.getElementById('orderTypeModal').style.display = 'flex';
};

function selectOrderType(type) {
    currentOrderType = type;
    document.getElementById('orderTypeModal').style.display = 'none';
    if (type === 'table') {
        if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø·Ø§ÙˆÙ„Ø©ØŸ')) finalizeOrder();
    } else {
        document.getElementById('customerModal').style.display = 'flex';
        document.getElementById('customerDetailsForm').style.display = 'none';
        document.getElementById('custPhone').value = '';
    }
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„
function searchCustomer() {
    const phone = document.getElementById('custPhone').value.trim();
    if (!phone) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù‚Ù…');

    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
    const url = "{% url 'search_customer' %}?phone=" + phone;

    fetch(url)
    .then(res => res.json())
    .then(data => {
        document.getElementById('customerDetailsForm').style.display = 'block';
        if (data.found) {
            document.getElementById('custName').value = data.name;
            document.getElementById('custAddress').value = data.address;
        } else {
            alert('Ø±Ù‚Ù… Ø¬Ø¯ÙŠØ¯ØŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            document.getElementById('custName').value = '';
            document.getElementById('custAddress').value = '';
        }
    })
    .catch(err => alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±'));
}

// ØªÙ†ÙÙŠØ° Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
function finalizeOrder() {
    const total = parseFloat(document.getElementById('totalDisplay').innerText);
    let customerData = null;

    if (currentOrderType === 'delivery') {
        customerData = {
            phone: document.getElementById('custPhone').value,
            name: document.getElementById('custName').value,
            address: document.getElementById('custAddress').value
        };
        if (!customerData.name || !customerData.address) return alert('ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„');
    }

    fetch("{% url 'cash_checkout' %}", {
        method: 'POST',
        headers: { 
            'Content-Type': 'application/json', 
            'X-CSRFToken': '{{ csrf_token }}' 
        },
        body: JSON.stringify({ cart, total, order_type: currentOrderType, customer_data: customerData })
    })
    .then(res => {
        if (!res.ok) return res.json().then(err => { throw new Error(err.message) });
        return res.json();
    })
    .then(data => {
        if(data.status === 'success') {
            // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­
            updatePrintReceipt(data.order_id, total, customerData);
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
            const printArea = document.getElementById('receipt-print-area');
            printArea.style.display = 'block';
            window.print();
            printArea.style.display = 'none';
            
            // ØªØµÙÙŠØ± Ø§Ù„ØµÙØ­Ø©
            cart = [];
            renderCart();
            closeModals();
            alert('ØªÙ… Ø§Ù„Ø¨ÙŠØ¹ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²Ù† Ø¨Ù†Ø¬Ø§Ø­!');
        }
    })
    .catch(err => {
        console.error(err);
        alert('ÙØ´Ù„Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ' + err.message);
    });
}

function updatePrintReceipt(orderId, total, customerData) {
    document.getElementById('print-order-id').innerText = orderId;
    document.getElementById('print-date').innerText = new Date().toLocaleString('ar-EG');
    document.getElementById('print-total').innerText = total.toFixed(2);
    
    const itemsBody = document.getElementById('print-items-body');
    itemsBody.innerHTML = cart.map(item => `
        <tr>
            <td style="padding: 5px 0;">${item.name}</td>
            <td style="text-align: center;">${item.qty}</td>
            <td style="text-align: left;">${(item.price * item.qty).toFixed(2)}</td>
        </tr>
    `).join('');
}

function closeModals() { document.querySelectorAll('.custom-modal').forEach(m => m.style.display='none'); }

// Ø§Ù„ÙÙ„ØªØ±Ø© ÙˆØ§Ù„Ø¨Ø­Ø«
document.getElementById('posSearch').oninput = (e) => {
    const term = e.target.value.toLowerCase();
    document.querySelectorAll('.product-item').forEach(item => {
        item.style.display = item.querySelector('.product-title').innerText.toLowerCase().includes(term) ? 'flex' : 'none';
    });
};

document.querySelectorAll('.cat-pill').forEach(pill => {
    pill.onclick = function() {
        document.querySelectorAll('.cat-pill').forEach(p => p.classList.remove('active'));
        this.classList.add('active');
        const filter = this.dataset.filter;
        document.querySelectorAll('.product-item').forEach(item => {
            item.style.display = (filter === 'all' || item.dataset.category === filter) ? 'flex' : 'none';
        });
    };
});
</script>

<div id="receipt-print-area" style="display: none;">
    <div class="receipt-container" style="width: 80mm; font-family: 'Cairo', sans-serif; direction: rtl; padding: 5px;">
        <div style="text-align: center; margin-bottom: 10px;">
            <h2 style="margin: 0;">ÙØ·Ø§Ø·Ø±ÙŠ Ø¹Ø¨Ø§Ø¯ Ø§Ù„Ø±Ø­Ù…Ù†</h2>
            <p style="font-size: 12px; margin: 5px 0;">ÙØ±Ø¹ Ø·Ù‡Ø·Ø§ - Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</p>
            <hr>
            <h4 id="print-order-type" style="margin: 5px 0; background: #eee; padding: 2px;"></h4>
        </div>

        <div style="font-size: 13px; margin-bottom: 10px;">
            <div>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: <span id="print-order-id"></span></div>
            <div>Ø§Ù„ØªØ§Ø±ÙŠØ®: <span id="print-date"></span></div>
            <div id="print-customer-info" style="display: none;">
                <hr>
                <div>Ø§Ù„Ø¹Ù…ÙŠÙ„: <span id="print-cust-name"></span></div>
                <div>Ø§Ù„Ù‡Ø§ØªÙ: <span id="print-cust-phone"></span></div>
                <div>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: <span id="print-cust-address"></span></div>
            </div>
        </div>

        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead style="border-bottom: 1px dashed #000;">
                <tr>
                    <th style="text-align: right;">Ø§Ù„ØµÙ†Ù</th>
                    <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                    <th style="text-align: left;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                </tr>
            </thead>
            <tbody id="print-items-body">
                </tbody>
        </table>

        <hr style="border-top: 1px dashed #000;">
        <div style="text-align: left; font-weight: bold; font-size: 15px;">
            Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: <span id="print-total"></span> Ø¬.Ù…
        </div>
        
        <div style="text-align: center; margin-top: 20px; font-size: 11px;">
            <p>Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ…!</p>
            <p>Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ± Ø§Ø­Ù…Ø¯ Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ… </p>
        </div>
    </div>
</div>
{% endblock %}