{% extends 'base.html' %}
{% load static %}

{% block title %}Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ - ÙƒØ±ÙŠÙ… Ù‡Ø±ÙŠØ¯ÙŠ Ù„Ù„Ø¨Ø¯Ù„{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pos.css' %}">
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
<style>
    /* Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© */
    .cart-sidebar { display: flex; flex-direction: column; height: calc(100vh - 20px); position: sticky; top: 10px; }
    #cartItemsContainer { flex: 1; overflow-y: auto; padding-right: 5px; min-height: 200px; }
    .btn-top-action { color: white !important; text-decoration: none; padding: 8px 15px; border-radius: 8px; font-size: 0.9rem; font-weight: bold; margin-left: 10px; display: flex; align-items: center; gap: 5px; border: none; cursor: pointer; font-family: 'Cairo'; }
    .btn-return { background-color: #f39c12; }
    .btn-rental-trigger { background-color: #e67e22; }

    /* Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© */
    .custom-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
    .modal-content { background: white; padding: 25px; border-radius: 15px; width: 450px; direction: rtl; font-family: 'Cairo', sans-serif; }
    .modal-btn { width: 100%; padding: 12px; margin: 8px 0; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1rem; }
    .btn-confirm { background: #27ae60; color: white; }
    .btn-cancel { background: none; color: #e74c3c; }
    .input-field { width: 100%; padding: 10px; margin: 8px 0; border: 2px solid #eee; border-radius: 8px; font-family: 'Cairo'; box-sizing: border-box; }
    .row-flex { display: flex; gap: 10px; }
    .row-flex div { flex: 1; }

    /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© - Ù…Ø·Ø§Ø¨Ù‚ ØªÙ…Ø§Ù…Ø§Ù‹ Ù„Ù„Ù…Ø«Ø§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ */
    @media print {
        @page { size: 80mm auto; margin: 0; }
        body { margin: 0; padding: 0; visibility: hidden; }
        #receipt-print-area { visibility: visible; position: absolute; left: 0; top: 0; width: 80mm; background: #fff; }
        #receipt-print-area * { visibility: visible; }
    }
    
    .receipt { width: 80mm; padding: 6px; box-sizing: border-box; font-size: 12px; font-family: 'Cairo', sans-serif; }
    .center { text-align: center; }
    .receipt hr { border: none; border-top: 1px dashed #000; margin: 6px 0; }
    .info { font-size: 11px; }
    .info div { display: flex; justify-content: space-between; }
    .receipt table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .receipt th, .receipt td { padding: 3px 0; }
    .receipt th { border-bottom: 1px dashed #000; }
    .receipt td:first-child, .receipt th:first-child { text-align: right; }
    .receipt td:last-child, .receipt th:last-child { text-align: left; }
    .total-row { font-weight: bold; font-size: 13px; }
    .footer { text-align: center; font-size: 11px; margin-top: 8px; }
</style>
{% endblock %}

{% block content %}
<div class="pos-wrapper">
    <section class="products-section">
        <header class="pos-top-bar">
            <div class="search-container">
                <i class="search-icon">ğŸ”</i>
                <input type="text" id="posSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù...">
            </div>
            <div class="user-actions">
                <a href="{% url 'orders' %}" class="btn-top-action btn-return">ğŸ”„ Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</a>
            </div>
        </header>

        <nav class="categories-container" style="background: #111; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
            <div class="cat-track" style="display: flex; gap: 12px; overflow-x: auto; padding-bottom: 5px;">
                <button class="cat-pill active" data-filter="all" style="min-width: 100px;">â­ Ø§Ù„ÙƒÙ„</button>
                
                {% for category in categories %}
                    <button class="cat-pill" data-filter="{{ category.id }}" style="min-width: 100px;">
                        {{ category.name|default:category }} 
                    </button>
                {% endfor %}
            </div>
        </nav>
        <div class="extra-filters" style="display: flex; gap: 10px; margin-bottom: 15px; padding: 0 10px;">
            <select id="sizeFilter" class="form-select-luxury" style="flex: 1; padding: 8px; border-radius: 8px; background: #1a1a1a; color: #d4af37; border: 1px solid #444;">
                <option value="all">ÙƒÙ„ Ø§Ù„Ù…Ù‚Ø§Ø³Ø§Øª</option>
                {% for size in sizes %}
                    <option value="{{ size.id }}">{{ size.size }}</option>
                {% endfor %}
            </select>

            <select id="colorFilter" class="form-select-luxury" style="flex: 1; padding: 8px; border-radius: 8px; background: #1a1a1a; color: #d4af37; border: 1px solid #444;">
                <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù†</option>
                {% for color in colors %}
                    <option value="{{ color.id }}">{{ color.color }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="products-layout" id="productsGrid">
            {% for item in products %} 
            <div class="product-item" 
                data-category="{{ item.category.id }}" 
                data-size="{{ item.size.id }}" 
                data-color="{{ item.color.id }}">
                <div class="product-main-info">
                    <h3 class="product-title">{{ item.name }}</h3>
                    <div class="product-price-tag">{{ item.unit_cost }} <span>Ø¬.Ù…</span></div>
                </div>
                <p class="product-desc">Ø§Ù„Ù…ØªØ§Ø­: {{ item.quantity }} | Ù…Ù‚Ø§Ø³: {{ item.size.size }}</p>
                <button class="add-to-cart-btn" data-id="{{ item.id }}" data-name="{{ item.name }}" data-price="{{ item.unit_cost }}"> Ø¥Ø¶Ø§ÙØ© + </button>
            </div>
            {% endfor %}
        </div>
    </section>

    <aside class="cart-sidebar">
        <div class="cart-header">
            <div class="cart-meta"><h2>Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2><span class="order-id">#Ù‚Ø§Ø¦Ù…Ø©_Ø§Ù„Ø¨ÙŠØ¹</span></div>
            <button class="clear-cart" id="clearCart">ğŸ—‘ï¸</button>
        </div>
        <div class="cart-items-container" id="cartItemsContainer"><div class="empty-cart-msg">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div></div>
        <div class="cart-summary-footer">
            <div class="bill-row"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span> <span id="totalDisplay" style="font-weight: bold;">0.00 Ø¬.Ù…</span></div>
            <button class="check-btn cash" id="cashCheckout" style="width: 100%; margin-top: 10px;">Ø§ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹ (ÙƒØ§Ø´)</button>
        </div>
    </aside>
</div>


<div id="orderTypeModal" class="custom-modal">
    <div class="modal-content" style="text-align: center;">
        <h3>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3>
        <button class="modal-btn btn-confirm" onclick="selectOrderType('table')">Ø¨ÙŠØ¹ Ù†Ù‚Ø¯ÙŠ Ø³Ø±ÙŠØ¹</button>
        <button class="modal-btn" style="background:#3498db; color:white;" onclick="selectOrderType('delivery')">ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù…ÙŠÙ„</button>
        <button class="modal-btn btn-cancel" onclick="closeModals()">ØªØ±Ø§Ø¬Ø¹</button>
    </div>
</div>

<div id="customerModal" class="custom-modal">
    <div class="modal-content">
        <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
        <input type="text" id="custPhone" class="input-field" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
        <button class="modal-btn btn-confirm" onclick="searchCustomer()">Ø¨Ø­Ø«</button>
        <div id="customerDetailsForm" style="display:none;">
            <input type="text" id="custName" class="input-field" placeholder="Ø§Ù„Ø§Ø³Ù…">
            <textarea id="custAddress" class="input-field" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"></textarea>
            <button class="modal-btn btn-confirm" onclick="finalizeOrder()">ØªØ£ÙƒÙŠØ¯ ğŸ–¨ï¸</button>
        </div>
    </div>
</div>

<div id="receipt-print-area" style="display: none;">
    <div class="receipt">
        <div class="center">
            <h2 style="margin:2px 0;">ÙƒØ±ÙŠÙ… Ù‡Ø±ÙŠØ¯ÙŠ</h2>
            <div>Ù…Ø­Ù„ Ø¨Ø¯Ù„ Ø±Ø¬Ø§Ù„ÙŠ</div>
            <div>Ø·Ø±ÙŠÙ‚ Ø£Ø³ÙŠÙˆØ· â€“ Ø³ÙˆÙ‡Ø§Ø¬</div>
            <div>ğŸ“ 01002528882</div>
        </div>

        <hr>

        <div class="info">
            <div><span>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</span><span id="p-id">#--</span></div>
            <div><span>Ø§Ù„ØªØ§Ø±ÙŠØ®</span><span id="p-date"></span></div>
            <div><span>Ø§Ù„Ù†ÙˆØ¹</span><span id="p-label"></span></div>
        </div>

        <hr>

        <table>
            <thead>
                <tr>
                    <th>Ø§Ù„ØµÙ†Ù</th>
                    <th style="text-align:center;">Ùƒ</th>
                    <th style="text-align:left;">Ø¬</th>
                </tr>
            </thead>
            <tbody id="p-items-body"></tbody>
        </table>

        <hr>

        <table>
            <tr class="total-row">
                <td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</td>
                <td></td>
                <td style="text-align:left;"><span id="p-total"></span> Ø¬.Ù…</td>
            </tr>
            <tr id="p-deposit-row" style="display:none; font-size: 11px;">
                <td>Ù…Ø¨Ù„Øº Ø§Ù„ØªØ£Ù…ÙŠÙ†</td>
                <td></td>
                <td style="text-align:left;"><span id="p-deposit"></span> Ø¬.Ù…</td>
            </tr>
        </table>

        <hr>

        <div class="footer">
            <div id="p-footer-msg">Ø´ÙƒØ±Ø§Ù‹ Ù„Ø²ÙŠØ§Ø±ØªÙƒÙ… ğŸŒ¹</div>
            <div id="p-footer-policy">Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø®Ù„Ø§Ù„ 14 ÙŠÙˆÙ…</div>
            <div style="margin-top:6px;">Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØ·ÙˆÙŠØ± Ø§Ø­Ù…Ø¯ Ø§Ø¨Ø±Ù‡ÙŠÙ…</div>
        </div>
    </div>
</div>

<script>
let cart = [];
let currentOrderType = 'table';

// Ø§Ù„Ø³Ù„Ø©
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('add-to-cart-btn')) {
        const btn = e.target;
        const product = { id: btn.dataset.id, name: btn.dataset.name, price: parseFloat(btn.dataset.price), qty: 1 };
        const existing = cart.find(item => item.id === product.id);
        if (existing) existing.qty++; else cart.push(product);
        renderCart();
    }
});

function renderCart() {
    const container = document.getElementById('cartItemsContainer');
    container.innerHTML = '';
    let total = 0;
    cart.forEach(item => {
        total += (item.price * item.qty);
        container.innerHTML += `<div class="cart-card" style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid #eee;">
            <span>${item.name} (${item.qty})</span>
            <span>${(item.price * item.qty).toFixed(2)}</span>
        </div>`;
    });
    document.getElementById('totalDisplay').innerText = total.toFixed(2) + ' Ø¬.Ù…';
}

function openRentalModal() { document.getElementById('rentStart').valueAsDate = new Date(); document.getElementById('rentalModal').style.display = 'flex'; }
function closeModals() { document.querySelectorAll('.custom-modal').forEach(m => m.style.display = 'none'); }

// Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªØ£Ø¬ÙŠØ±
function submitRental() {
    const data = {
        is_rental: true,
        item_name: document.getElementById('rentItemName').value,
        sizes: document.getElementById('rentSizes').value,
        notes: document.getElementById('rentNotes').value,
        price: document.getElementById('rentPrice').value,
        deposit: document.getElementById('rentDeposit').value,
        start_date: document.getElementById('rentStart').value,
        end_date: document.getElementById('rentEnd').value
    };

    if (!data.item_name || !data.price) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

    document.getElementById('p-label').innerText = "ÙØ§ØªÙˆØ±Ø© ØªØ£Ø¬ÙŠØ±";
    document.getElementById('p-date').innerText = new Date().toLocaleDateString('ar-EG');
    document.getElementById('p-total').innerText = parseFloat(data.price).toFixed(2);
    document.getElementById('p-deposit').innerText = parseFloat(data.deposit || 0).toFixed(2);
    document.getElementById('p-deposit-row').style.display = 'table-row';
    document.getElementById('p-footer-policy').innerText = "ÙŠØªÙ… Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„ØªØ£Ù…ÙŠÙ† Ø¹Ù†Ø¯ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø¨Ø¯Ù„Ø©";

    document.getElementById('p-items-body').innerHTML = `
        <tr>
            <td>
                ${data.item_name}<br>
                <small>Ø§Ù„Ù…Ù‚Ø§Ø³: ${data.sizes}</small><br>
                <small>Ù…Ù†: ${data.start_date} Ø¥Ù„Ù‰: ${data.end_date}</small>
            </td>
            <td style="text-align:center;">1</td>
            <td style="text-align:left;">${data.price}</td>
        </tr>`;

    window.print();

    fetch("{% url 'cash_checkout' %}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify(data)
    }).then(() => location.reload());
}

// Ø§ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
document.getElementById('cashCheckout').onclick = () => { if (cart.length > 0) document.getElementById('orderTypeModal').style.display = 'flex'; };

function selectOrderType(type) { currentOrderType = type; closeModals(); if (type === 'table') finalizeOrder(); else document.getElementById('customerModal').style.display = 'flex'; }

async function finalizeOrder() {
    const totalDisplay = document.getElementById('totalDisplay').innerText;
    const total = parseFloat(totalDisplay) || 0;
    
    const customerData = {
        phone: document.getElementById('custPhone')?.value || '',
        name: document.getElementById('custName')?.value || '',
        address: document.getElementById('custAddress')?.value || ''
    };

    try {
        // 1. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø³ÙŠØ±ÙØ± Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¬Ù„Ø¨ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        const res = await fetch("{% url 'cash_checkout' %}", {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'X-CSRFToken': '{{ csrf_token }}' 
            },
            body: JSON.stringify({ 
                cart: cart, 
                total: total, 
                order_type: currentOrderType,
                customer_data: customerData 
            })
        });

        const data = await res.json();

        if (data.status === 'success') {
            // 2. ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙŠ HTML Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¬Ø¹ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
            document.getElementById('p-id').innerText = "#" + data.order_id; // Ù‡Ù†Ø§ Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
            document.getElementById('p-label').innerText = "ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹ Ù†Ù‚Ø¯ÙŠ";
            document.getElementById('p-date').innerText = new Date().toLocaleString('ar-EG');
            document.getElementById('p-total').innerText = total.toFixed(2);
            document.getElementById('p-deposit-row').style.display = 'none';
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù
            document.getElementById('p-items-body').innerHTML = cart.map(i => `
                <tr>
                    <td>${i.name}</td>
                    <td style="text-align:center;">${i.qty}</td>
                    <td style="text-align:left;">${i.price.toFixed(2)}</td>
                </tr>`).join('');

            // 3. ØªØ´ØºÙŠÙ„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            setTimeout(() => {
                window.print();
                alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨ Ø±Ù‚Ù… #" + data.order_id);
                location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
            }, 500);

        } else {
            alert("Ø®Ø·Ø£: " + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert("ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
    }
}


function searchCustomer() {
    fetch("{% url 'search_customer' %}?phone=" + document.getElementById('custPhone').value)
    .then(res => res.json()).then(data => {
        document.getElementById('customerDetailsForm').style.display = 'block';
        if (data.found) { document.getElementById('custName').value = data.name; document.getElementById('custAddress').value = data.address; }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('posSearch');
    const sizeSelect = document.getElementById('sizeFilter');
    const colorSelect = document.getElementById('colorFilter');
    const catButtons = document.querySelectorAll('.cat-pill');
    const items = document.querySelectorAll('.product-item');

    function filterAll() {
        const query = searchInput.value.toLowerCase();
        const activeCat = document.querySelector('.cat-pill.active').dataset.filter;
        const selectedSize = sizeSelect.value;
        const selectedColor = colorSelect.value;

        items.forEach(item => {
            const name = item.querySelector('.product-title').innerText.toLowerCase();
            const cat = item.dataset.category;
            const size = item.dataset.size;
            const color = item.dataset.color;

            // Ø´Ø±ÙˆØ· Ø§Ù„ÙÙ„ØªØ±Ø©
            const matchesSearch = name.includes(query);
            const matchesCat = (activeCat === 'all' || cat === activeCat);
            const matchesSize = (selectedSize === 'all' || size === selectedSize);
            const matchesColor = (selectedColor === 'all' || color === selectedColor);

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬ ÙÙ‚Ø· Ø¥Ø°Ø§ ØªØ­Ù‚Ù‚Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ø±ÙˆØ·
            if (matchesSearch && matchesCat && matchesSize && matchesColor) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }

    // Ø§Ù„ØªÙ†ØµØª Ø¹Ù„Ù‰ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„
    searchInput.addEventListener('input', filterAll);
    sizeSelect.addEventListener('change', filterAll);
    colorSelect.addEventListener('change', filterAll);
    
    catButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            catButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            filterAll();
        });
    });
});
</script>
{% endblock %}