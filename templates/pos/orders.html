{% extends 'base.html' %}
{% load static %}

{% block title %}Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª - ÙØ·Ø§Ø·Ø±ÙŠ Ø§Ù„Ø¨Ø±ÙƒØ©{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/orders.css' %}">
{% endblock %}

{% block content %}
<div class="orders-container">
    <header class="orders-header">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1 style="font-weight: 800; color: var(--text-dark);">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h1>
            <button class="action-btn-view" onclick="window.print()" style="padding: 10px 20px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">ğŸ“¦</div>
                <div class="stat-info">
                    <p style="color: var(--text-gray); font-size: 0.85rem;">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©</p>
                    <h3 id="orderCountDisplay">{{ orders.count }}</h3>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">ğŸ’°</div>
                <div class="stat-info">
                    <p style="color: var(--text-gray); font-size: 0.85rem;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø©</p>
                    <h3 id="filteredSalesDisplay">{{ total_sales|default:"0.00" }} <small>Ø¬.Ù…</small></h3>
                </div>
            </div>
        </div>
    </header>

    <section class="filters-bar">
        <div class="filter-group" style="flex: 2;">
            <label>Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø³Ø±ÙŠØ¹ (Ø±Ù‚Ù…ØŒ Ù…ÙˆØ¸ÙØŒ ØµÙ†Ù)</label>
            <div class="search-box">
                <input type="text" id="proSearchInput" placeholder="Ø§ÙƒØªØ¨ Ù„Ù„Ø¨Ø­Ø«...">
            </div>
        </div>
        
        <div class="filter-group" style="flex: 1;">
            <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
            <select id="paymentFilter" class="custom-select">
                <option value="all">Ø§Ù„ÙƒÙ„</option>
                <option value="cash">Ù†Ù‚Ø¯Ø§Ù‹ (Cash)</option>
                <option value="visa">ÙÙŠØ²Ø§ (Visa)</option>
            </select>
        </div>

        {% if request.user.role == 'manager' %}
        <div class="filter-group" style="flex: 1;">
            <label>Ø§Ù„Ù…ÙˆØ¸Ù</label>
            <select id="staffFilter" class="custom-select">
                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
                {% for staff in staff_members %}
                <option value="{{ staff.get_full_name|default:staff.username }}">{{ staff.get_full_name|default:staff.username }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </section>

    <div class="table-wrapper">
        <table class="orders-table" id="ordersTable">
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ø¹Ø±Ù</th>
                    <th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>
                    <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                    <th>Ø§Ù„ÙˆØ³ÙŠÙ„Ø©</th>
                    <th>Ø§Ù„Ù…Ù„Ø®Øµ</th>
                    <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="ordersBody">
                {% for order in orders %}
                <tr class="order-row fade-in" 
                    data-payment="{{ order.payment_method }}" 
                    data-staff="{{ order.user.get_full_name|default:order.user.username }}">
                    <td class="order-id">#{{ order.id }}</td>
                    <td>
                        <div style="font-weight: 600;">{{ order.created_at|date:"d/m/Y" }}</div>
                        <div style="font-size: 0.75rem; color: var(--text-gray);">{{ order.created_at|date:"h:i A" }}</div>
                    </td>
                    <td>
                        <div class="staff-profile">
                            <div class="avatar-circle">{{ order.user.get_full_name|default:order.user.username|slice:":1" }}</div>
                            <span>{{ order.user.get_full_name|default:order.user.username }}</span>
                        </div>
                    </td>
                    <td>
                        <span class="payment-badge {{ order.payment_method }}">
                            {{ order.get_payment_method_display }}
                        </span>
                    </td>
                    <td>
                        <div style="font-size: 0.85rem; color: var(--text-gray); max-width: 200px;">
                            {% for item in order.items.all %}
                                {{ item.product.name }}{% if not forloop.last %}ØŒ {% endif %}
                            {% endfor %}
                        </div>
                    </td>
                    <td style="font-weight: 800;"><span class="price-val">{{ order.total_price }}</span> Ø¬.Ù…</td>
                    <td>
                        <a href="{% url 'order_detail' order.id %}" class="action-btn-view" style="text-decoration: none;">ğŸ‘ï¸</a>
                    </td>
                </tr>
                {% empty %}
                <tr><td colspan="7" style="text-align:center; padding: 2rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('proSearchInput');
    const paymentFilter = document.getElementById('paymentFilter');
    const staffFilter = document.getElementById('staffFilter');
    const rows = document.querySelectorAll('.order-row');
    const filteredSalesDisplay = document.getElementById('filteredSalesDisplay');
    const orderCountDisplay = document.getElementById('orderCountDisplay');

    function filterData() {
        const query = searchInput.value.toLowerCase();
        const payment = paymentFilter.value;
        const staffValue = staffFilter ? staffFilter.value.toLowerCase() : 'all';
        
        let total = 0;
        let count = 0;

        rows.forEach(row => {
            // Ø¬Ù„Ø¨ Ø§Ù„Ù†Øµ Ù…Ù† ÙƒÙ„ Ø§Ù„Ø®Ù„Ø§ÙŠØ§ Ù„Ù„Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Ù…Ù„
            const rowText = row.innerText.toLowerCase();
            const rowPayment = row.getAttribute('data-payment');
            const rowStaff = row.getAttribute('data-staff').toLowerCase();
            const price = parseFloat(row.querySelector('.price-val').innerText);

            const matchesSearch = rowText.includes(query);
            const matchesPayment = (payment === 'all' || rowPayment === payment);
            const matchesStaff = (staffValue === 'all' || rowStaff === staffValue);

            if (matchesSearch && matchesPayment && matchesStaff) {
                row.style.display = '';
                total += price;
                count++;
            } else {
                row.style.display = 'none';
            }
        });

        filteredSalesDisplay.innerHTML = `${total.toFixed(2)} <small>Ø¬.Ù…</small>`;
        orderCountDisplay.innerText = count;
    }

    searchInput.addEventListener('input', filterData);
    paymentFilter.addEventListener('change', filterData);
    if (staffFilter) staffFilter.addEventListener('change', filterData);
});
</script>
{% endblock %}