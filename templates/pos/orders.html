{% extends 'base.html' %}
{% load static %}

{% block title %}Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø´Ø§Ù…Ù„ - ÙƒØ±ÙŠÙ… Ù‡Ø±ÙŠØ¯Ø±ÙŠ Ù„Ù„Ø¨Ø¯Ù„ Ø§Ù„Ø±Ø¬Ø§Ù„ÙŠ{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/orders.css' %}">
{% endblock %}

{% block content %}
<div class="orders-container">
    <header class="orders-header">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h1 style="font-weight: 800; color: var(--text-dark);">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¨ÙŠØ¹ ÙˆØ¥ÙŠØ¬Ø§Ø±)</h1>
            <button class="action-btn-view" onclick="window.print()" style="padding: 10px 20px;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</button>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon blue">ğŸ“¦</div>
                <div class="stat-info">
                    <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©</p>
                    <h3 id="orderCountDisplay">{{ orders|length }}</h3>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon green">ğŸ’°</div>
                <div class="stat-info">
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ÙÙ„ØªØ±Ø©</p>
                    <h3 id="filteredSalesDisplay">{{ total_sales|default:"0.00" }} <small>Ø¬.Ù…</small></h3>
                </div>
            </div>
        </div>
    </header>

    <section class="filters-bar">
        <div class="filter-group" style="flex: 2;">
            <label>Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Ù…Ù„</label>
            <input type="text" id="proSearchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø±Ù‚Ù…ØŒ Ø§Ù„ØµÙ†Ù...">
        </div>
        
        <div class="filter-group" style="flex: 1;">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
            <select id="typeFilter" class="custom-select">
                <option value="all">Ø§Ù„ÙƒÙ„</option>
                <option value="sale">Ø¨ÙŠØ¹ Ù…Ø¨Ø§Ø´Ø±</option>
                <option value="rental">Ø¥ÙŠØ¬Ø§Ø±</option>
            </select>
        </div>

        {% if request.user.role == 'manager' %}
        <div class="filter-group" style="flex: 1;">
            <label>Ø§Ù„Ù…ÙˆØ¸Ù</label>
            <select id="staffFilter" class="custom-select">
                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
                {% for staff in staff_members %}
                <option value="{{ staff.get_full_name|default:staff.username }}">{{ staff.get_full_name|default:staff.username }}</option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </section>

    <div class="table-wrapper">
        <table class="orders-table" id="ordersTable">
            <thead>
                <tr>
                    <th>Ø§Ù„Ù…Ø¹Ø±Ù/Ø§Ù„Ù†ÙˆØ¹</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th>Ø§Ù„Ø¹Ù…ÙŠÙ„/Ø§Ù„Ù…ÙˆØ¸Ù</th>
                    <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                    <th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="ordersBody">
                {% for order in orders %}
                <tr class="order-row" 
                    data-type="{{ order.order_type }}"
                    data-staff="{% if order.order_type == 'sale' %}{{ order.user.get_full_name|default:order.user.username }}{% else %}Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ£Ø¬ÙŠØ±{% endif %}">
                    
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 5px; align-items: flex-start;">
                            <span class="id-badge">#{{ order.id }}</span>
                            <span class="order-type-tag {% if order.order_type == 'sale' %}type-sale{% else %}type-rental{% endif %}">
                                {% if order.order_type == 'sale' %}ğŸ“¦ Ø¨ÙŠØ¹{% else %}ğŸ”„ Ø¥ÙŠØ¬Ø§Ø±{% endif %}
                            </span>
                        </div>
                    </td>
            
                    <td>
                        <span class="order-date">
                            {% if order.order_type == 'sale' %}{{ order.created_at|date:"d/m/Y" }}{% else %}{{ order.rental_date|date:"d/m/Y" }}{% endif %}
                        </span>
                        <span class="order-time">
                            {% if order.order_type == 'sale' %}{{ order.created_at|date:"h:i A" }}{% else %}Ø¹ÙˆØ¯Ø©: {{ order.return_date|date:"d/m/Y" }}{% endif %}
                        </span>
                    </td>
            
                    <td>
                        <span class="staff-name">{{ order.customer.name|default:"Ø¹Ù…ÙŠÙ„ Ù†Ù‚Ø¯ÙŠ" }}</span>
                        <span class="staff-role">Ø¨ÙˆØ§Ø³Ø·Ø©: {% if order.order_type == 'sale' %}{{ order.user.username }}{% else %}Ù†Ø¸Ø§Ù…{% endif %}</span>
                    </td>
            
                    <td>
                        <div style="font-size: 0.9rem; color: var(--text-muted); max-width: 250px;">
                            {% if order.order_type == 'sale' %}
                                {% for item in order.items.all %}{{ item.product.name }}{% if not forloop.last %}ØŒ {% endif %}{% endfor %}
                            {% else %}
                                {{ order.item.item.name }} (Ù…Ù‚Ø§Ø³: {{ order.size.size }})
                            {% endif %}
                        </div>
                    </td>
            
                    <td style="font-weight: 800; font-size: 1.1rem; color: var(--primary-gold);">
                        <span class="price-val">{{ order.total_price }}</span> <small>Ø¬.Ù…</small>
                    </td>
                    
                    <td>
                        <div class="btn-group">
                            {% if order.order_type == 'sale' %}
                                <a href="{% url 'order_detail' order.id %}" class="action-btn view" title="Ù…Ø¹Ø§ÙŠÙ†Ø©">ğŸ‘ï¸</a>
                                <a href="{% url 'print_invoice' order.id %}" target="_blank" class="action-btn print" title="Ø·Ø¨Ø§Ø¹Ø©">ğŸ–¨ï¸</a>
                            {% else %}
                                <a href="#" class="action-btn view" title="Ù…Ø¹Ø§ÙŠÙ†Ø©">ğŸ‘ï¸</a>
                                <a href="{% url 'print_rental_contract' order.id %}" target="_blank" class="action-btn print" style="color: var(--warning-orange);" title="Ø·Ø¨Ø§Ø¹Ø©">ğŸ–¨ï¸</a>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('proSearchInput');
    const typeFilter = document.getElementById('typeFilter');
    const staffFilter = document.getElementById('staffFilter');
    const rows = document.querySelectorAll('.order-row');

    function filterData() {
        const query = searchInput.value.toLowerCase();
        const type = typeFilter.value;
        const staffValue = staffFilter ? staffFilter.value.toLowerCase() : 'all';
        
        let total = 0;
        let count = 0;

        rows.forEach(row => {
            const rowText = row.innerText.toLowerCase();
            const rowType = row.getAttribute('data-type');
            const rowStaff = row.getAttribute('data-staff').toLowerCase();
            const priceElement = row.querySelector('.price-val');
            const price = priceElement ? parseFloat(priceElement.innerText) : 0;

            const matchesSearch = rowText.includes(query);
            const matchesType = (type === 'all' || rowType === type);
            const matchesStaff = (staffValue === 'all' || rowStaff === staffValue);

            if (matchesSearch && matchesType && matchesStaff) {
                row.style.display = '';
                total += price;
                count++;
            } else {
                row.style.display = 'none';
            }
        });

        const salesDisplay = document.getElementById('filteredSalesDisplay');
        const countDisplay = document.getElementById('orderCountDisplay');
        
        if(salesDisplay) salesDisplay.innerHTML = `${total.toFixed(2)} <small>Ø¬.Ù…</small>`;
        if(countDisplay) countDisplay.innerText = count;
    }

    if(searchInput) searchInput.addEventListener('input', filterData);
    if(typeFilter) typeFilter.addEventListener('change', filterData);
    if(staffFilter) staffFilter.addEventListener('change', filterData);
});
</script>
{% endblock %}