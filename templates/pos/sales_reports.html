{% extends 'base.html' %}
{% load static %}

{% block title %}Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª - ÙØ·Ø§Ø·Ø±ÙŠ Ø§Ù„Ø¨Ø±ÙƒØ©{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reports.css' %}">
<style>
    .staff-select-box {
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #ddd;
        font-family: inherit;
        outline: none;
        background-color: white;
    }
    .active-staff-indicator {
        background: #e67e22;
        color: white;
        padding: 2px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        margin-right: 10px;
    }
    /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø© ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
    .status-text {
        font-size: 0.8rem;
        padding: 2px 8px;
        border-radius: 4px;
        background: #f1f5f9;
    }
</style>
{% endblock %}

{% block content %}
<div class="reports-container">
    <header class="reports-header">
        <div class="header-right">
            <h1>
                {% if is_manager %}ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©{% else %}ğŸ‘¨â€ğŸ³ Ù…Ù„Ø®Øµ Ø£Ø¯Ø§Ø¦ÙŠ Ø§Ù„Ø´Ø®ØµÙŠ{% endif %}
                {% if selected_staff_name %}<span class="active-staff-indicator">Ø§Ù„Ù…ÙˆØ¸Ù: {{ selected_staff_name }}</span>{% endif %}
            </h1>
            <p>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© (ØªØ­Ø¯ÙŠØ«: {{ now|date:"h:i A" }})</p>
        </div>
        <div class="header-left">
            <button class="btn-print" onclick="window.print()">ğŸ“¥ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
    </header>

    <section class="reports-control-bar">
        <div class="time-range-selector">
            <a href="?range=today&staff_id={{ selected_staff }}&status_id={{ selected_status }}" class="range-btn {% if filter_type == 'today' %}active{% endif %}">Ø§Ù„ÙŠÙˆÙ…</a>
            <a href="?range=week&staff_id={{ selected_staff }}&status_id={{ selected_status }}" class="range-btn {% if filter_type == 'week' %}active{% endif %}">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</a>
            <a href="?range=month&staff_id={{ selected_staff }}&status_id={{ selected_status }}" class="range-btn {% if filter_type == 'month' %}active{% endif %}">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</a>
        </div>

        <form class="custom-date-form" method="GET">
            <input type="hidden" name="range" value="custom">
            
            {% if is_manager %}
            <div class="date-input-group">
                <label>Ø§Ù„Ù…ÙˆØ¸Ù:</label>
                <select name="staff_id" class="staff-select-box">
                    <option value="all">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>
                    {% for staff in staff_members %}
                    <option value="{{ staff.id }}" {% if selected_staff == staff.id|stringformat:"i" %}selected{% endif %}>
                        {{ staff.get_full_name|default:staff.username }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <div class="date-input-group">
                <label>Ø§Ù„Ø­Ø§Ù„Ø©:</label>
                <select name="status_id" class="staff-select-box">
                    <option value="all">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                    {% for status in all_statuses %}
                    <option value="{{ status.id }}" {% if selected_status == status.id|stringformat:"i" %}selected{% endif %}>
                        {{ status.status }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="date-input-group">
                <label>Ù…Ù†:</label>
                <input type="date" name="start_date" value="{{ request.GET.start_date }}">
            </div>
            <div class="date-input-group">
                <label>Ø¥Ù„Ù‰:</label>
                <input type="date" name="end_date" value="{{ request.GET.end_date }}">
            </div>
            <button type="submit" class="btn-filter-apply">ØªØ·Ø¨ÙŠÙ‚</button>
        </form>
    </section>

    <section class="reports-stats">
        <div class="stat-card">
            <div class="stat-icon-box green">ğŸ’°</div>
            <div class="stat-content">
                <span class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
                <h2 class="stat-value">{{ stats.total_sales|floatformat:2 }} <small>Ø¬.Ù…</small></h2>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon-box orange">ğŸ“‹</div>
            <div class="stat-content">
                <span class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</span>
                <h2 class="stat-value">{{ stats.orders_count }}</h2>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon-box blue">ğŸ“Š</div>
            <div class="stat-content">
                <span class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø·Ù„Ø¨</span>
                <h2 class="stat-value">{{ stats.avg_order|floatformat:2 }} <small>Ø¬.Ù…</small></h2>
            </div>
        </div>
    </section>

    <div class="reports-main-grid">
        <div class="best-selling-section">
            <div class="section-header"><h3>ğŸ”¥ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹</h3></div>
            <div class="best-seller-list">
                {% for item in best_sellers %}
                <div class="best-item">
                    <div class="item-meta">
                        <span>{{ item.product__name }}</span>
                        <span>{{ item.total_qty }} Ø·Ù„Ø¨</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-fill" style="width: {% if stats.orders_count > 0 %}{% widthratio item.total_qty stats.orders_count 100 %}{% else %}0{% endif %}%"></div>
                    </div>
                </div>
                {% empty %}
                <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</p>
                {% endfor %}
            </div>
        </div>

        <div class="recent-orders-section">
            <div class="section-header"><h3>ğŸ“‘ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ÙÙ„ØªØ±</h3></div>
            <div class="table-wrapper">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</th>
                            <th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th> {% if is_manager %}<th>Ø§Ù„ÙƒØ§Ø´ÙŠØ±</th>{% endif %}
                            <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in recent_orders %}
                        <tr>
                            <td>#{{ order.id }}</td>
                            <td>{{ order.created_at|date:"d/m | h:i A" }}</td>
                            <td><span class="status-text">{{ order.status.status }}</span></td>
                            {% if is_manager %}<td>{{ order.user.get_full_name|default:order.user.username }}</td>{% endif %}
                            <td><strong>{{ order.total_price }} Ø¬.Ù…</strong></td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ù‡Ø°Ø§ Ø§Ù„ÙÙ„ØªØ±.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}