{% extends 'base.html' %}
{% load static %}

{% block title %}إدارة المخزون - متجر الفخامة{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/inventory.css' %}">
    <style>
        .form-select-luxury, .form-select-luxury option { color: #ffffff !important; background-color: #1a1a1a !important; }
        .luxury-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 2000; align-items: flex-start; padding: 40px 10px; overflow-y: auto; }
        .modal-card.large-card { margin: auto; max-height: none; }
        .hidden-field { display: none; }
        .search-success { border-color: #27ae60 !important; background: rgba(39, 174, 96, 0.1); }
        .search-new { border-color: #3498db !important; background: rgba(52, 152, 219, 0.1); }
    </style>
{% endblock %}

{% block content %}
<div class="inventory-page-wrapper" dir="rtl">
    
    <header class="inventory-main-header">
        <div class="header-text">
            <h1 class="page-title">إدارة المخزون</h1>
            <p class="page-subtitle">إدارة الأصناف والموردين والربط المالي التلقائي.</p>
        </div>
        <div class="header-actions">
            <button onclick="openModal('addItemModal')" class="btn-primary-luxury">
                <span class="material-symbols-outlined">add_circle</span>
                <span class="btn-text">إضافة صنف جديد</span>
            </button>
        </div>
    </header>

    <section class="stats-container">
        <div class="luxury-card stat-item">
            <div class="stat-info"><span class="label">إجمالي الأصناف</span><span class="value">{{ items.count }}</span></div>
            <span class="material-symbols-outlined icon-bg">inventory</span>
        </div>
        <div class="luxury-card stat-item total-value-border">
            <div class="stat-info">
                <span class="label text-emerald">إجمالي القيمة التقديرية</span>
                <span class="value text-emerald">{{ inventory_value|floatformat:2 }} <small>ج.م</small></span>
            </div>
            <span class="material-symbols-outlined icon-bg emerald-icon">payments</span>
        </div>
    </section>

    <div class="inventory-table-container">
        <table class="luxury-data-table" id="inventoryTable">
            <thead>
                <tr>
                    <th>الصنف</th>
                    <th>المواصفات</th>
                    <th>المورد</th>
                    <th>تكلفة التوريد</th>
                    <th>سعر البيع</th>
                    <th>الكمية</th>
                    <th class="text-center">الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td><strong>{{ item.name }}</strong></td>
                    <td><span class="unit-badge">{{ item.unit }}</span></td>
                    <td><span class="table-text-muted">{{ item.Supplier.name|default:"-" }}</span></td>
                    <td><span class="price-text">{{ item.supply_cost }} ج.م</span></td>
                    <td><span class="price-text-gold">{{ item.unit_cost }} ج.م</span></td>
                    <td>
                        {% if item.quantity <= item.min_limit %}
                            <div class="status-badge-luxury status-red">{{ item.quantity|floatformat:2 }}</div>
                        {% else %}
                            <div class="status-badge-luxury status-green">{{ item.quantity|floatformat:2 }}</div>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <button onclick="openUpdateModal('{{ item.id }}', '{{ item.name }}')" class="btn-action-icon edit-btn">
                            <span class="material-symbols-outlined">edit_square</span>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="addItemModal" class="luxury-modal-overlay">
    <div class="modal-card large-card">
        <div class="modal-header-with-icon">
            <span class="material-symbols-outlined gold-text">add_box</span>
            <h3>إضافة صنف جديد وحساب مبالغ المورد</h3>
        </div>
        
        <form action="{% url 'add_inventory_item' %}" method="POST" class="luxury-form-grid">
            {% csrf_token %}
            
            <div class="full-row">
                <label class="form-label">اسم الصنف</label>
                <input name="name" type="text" required class="form-input-luxury" placeholder="مثال: قماش صوف إيطالي">
            </div>

            <div class="half-row">
                <label class="form-label" style="color: #d4af37;">رقم هاتف المورد (للبحث)</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="sup_phone_search" name="supplier_phone_input" class="form-input-luxury" placeholder="أدخل الرقم...">
                    <button type="button" class="btn-primary-luxury" onclick="searchSupplier()">بحث</button>
                </div>
            </div>

            <div class="half-row">
                <label class="form-label">المورد المختار</label>
                <select name="Supplier" id="supplier_select" class="form-select-luxury">
                    <option value="">-- اختر مورد أو ابحث بالهاتف --</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}" data-phone="{{ supplier.phone }}">{{ supplier.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="new_supplier_fields" class="full-row hidden-field" style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 10px; border: 1px dashed #3498db;">
                <label class="form-label">اسم المورد الجديد</label>
                <input type="text" id="new_supplier_name" name="new_supplier_name" class="form-input-luxury" placeholder="سيتم إنشاء مورد جديد بهذا الاسم">
            </div>

            <div class="half-row">
                <label class="form-label">الفئة</label>
                <select name="category" class="form-select-luxury" required>
                    {% for cat in categories %}<option value="{{ cat.id }}">{{ cat }}</option>{% endfor %}
                </select>
            </div>
            <div class="half-row">
                <label class="form-label">الوحدة</label>
                <select name="unit" class="form-select-luxury" required>
                    {% for unit in units %}<option value="{{ unit.id }}">{{ unit }}</option>{% endfor %}
                </select>
            </div>

            <div class="third-row">
                <label class="form-label">الكمية الافتتاحية</label>
                <input name="quantity" type="number" step="0.01" required value="0" class="form-input-luxury">
            </div>
            <div class="third-row">
                <label class="form-label">تكلفة التوريد (للوحدة)</label>
                <input name="supply_cost" type="number" step="0.01" required value="0" class="form-input-luxury">
            </div>
            <div class="third-row">
                <label class="form-label">سعر البيع المقترح</label>
                <input name="unit_cost" type="number" step="0.01" required value="0" class="form-input-luxury">
            </div>

            <div class="modal-footer-actions full-row">
                <button type="submit" class="btn-primary-luxury full-width">حفظ وتسجيل الحركة المالية</button>
                <button type="button" onclick="closeModal('addItemModal')" class="btn-secondary-luxury">إلغاء</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // وظيفة البحث عن المورد بنفس منطق الـ POS
    function searchSupplier() {
        const phone = document.getElementById('sup_phone_search').value.trim();
        const select = document.getElementById('supplier_select');
        const newFields = document.getElementById('new_supplier_fields');
        const phoneInput = document.getElementById('sup_phone_search');

        if (!phone) return alert('يرجى إدخال رقم الهاتف أولاً');

        fetch(`/pos/check-supplier/?phone=${phone}`)
            .then(res => res.json())
            .then(data => {
                if (data.found) {
                    // مورد موجود
                    select.value = data.id;
                    newFields.classList.add('hidden-field');
                    phoneInput.classList.add('search-success');
                    phoneInput.classList.remove('search-new');
                    alert('تم ربط المورد: ' + data.name);
                } else {
                    // مورد جديد
                    select.value = "";
                    newFields.classList.remove('hidden-field');
                    phoneInput.classList.add('search-new');
                    phoneInput.classList.remove('search-success');
                    document.getElementById('new_supplier_name').focus();
                    alert('رقم هاتف جديد، يرجى كتابة اسم المورد');
                }
            })
            .catch(err => alert('خطأ في الاتصال بالبيانات'));
    }

    // البحث السريع في الجدول
    document.getElementById('inventorySearch')?.addEventListener('input', function(e) {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll('#inventoryTable tbody tr').forEach(row => {
            row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
        });
    });
</script>
{% endblock %}