{% extends 'base.html' %}
{% load static %}

{% block title %}إدارة المخزون - متجر الفخامة{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/inventory.css' %}">
    <style>
        /* الحفاظ على التنسيقات الأصلية الخاصة بك */
        .form-select-luxury, .form-select-luxury option { color: #ffffff !important; background-color: #1a1a1a !important; }
        .luxury-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 2000; align-items: flex-start; padding: 40px 10px; overflow-y: auto; }
        .modal-card.large-card { margin: auto; max-height: none; }
        .hidden-field { display: none; }
        .search-success { border-color: #27ae60 !important; background: rgba(39, 174, 96, 0.1); }
        .search-new { border-color: #3498db !important; background: rgba(52, 152, 219, 0.1); }
        
        /* تنسيقات نافذة التحكم المضافة (تعديل/توريد/حذف) بنفس نمطك */
        .control-modal { width: 100%; max-width: 500px; background: #1a1a1a; border: 1px solid #d4af37; border-radius: 20px; padding: 25px; margin: auto; }
        .tabs-header { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; justify-content: center; }
        .tab-btn { background: none; border: none; color: #888; cursor: pointer; padding: 8px 15px; font-weight: bold; transition: 0.3s; font-family: inherit; }
        .tab-btn.active { color: #d4af37; border-bottom: 2px solid #d4af37; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
{% endblock %}

{% block content %}
<div class="inventory-page-wrapper" dir="rtl">
    
    <header class="inventory-main-header">
        <div class="header-text">
            <h1 class="page-title">إدارة المخزون</h1>
            <p class="page-subtitle">إدارة الأصناف والموردين والربط المالي التلقائي.</p>
        </div>
        <div class="header-actions">
            <button onclick="openModal('addItemModal')" class="btn-primary-luxury">
                <span class="material-symbols-outlined">add_circle</span>
                <span class="btn-text">إضافة صنف جديد</span>
            </button>
        </div>
    </header>

    <section class="stats-container">
        <div class="luxury-card stat-item">
            <div class="stat-info">
                <span class="label">إجمالي أنواع الأصناف</span>
                <span class="value">{{ total_items_count }}</span>
            </div>
            <span class="material-symbols-outlined icon-bg">inventory</span>
        </div>

        <div class="luxury-card stat-item" style="border-right: 4px solid #ff4757; background: rgba(255, 71, 87, 0.05);">
            <div class="stat-info">
                <span class="label" style="color: #ff4757;">أصناف تحتاج شراء</span>
                <span class="value" style="color: #ff4757;">{{ low_stock_count }}</span>
            </div>
            <span class="material-symbols-outlined icon-bg" style="color: rgba(255, 71, 87, 0.2);">shopping_cart_checkout</span>
        </div>

        <div class="luxury-card stat-item total-value-border">
            <div class="stat-info">
                <span class="label text-emerald">إجمالي القيمة التقديرية</span>
                <span class="value text-emerald">{{ inventory_value|floatformat:2 }} <small>ج.م</small></span>
            </div>
            <span class="material-symbols-outlined icon-bg emerald-icon">payments</span>
        </div>
        
        <div class="luxury-card stat-item" style="border-right: 4px solid #d4af37;">
            <div class="stat-info">
                <span class="label" style="color: #d4af37;">إجمالي الربح المتوقع</span>
                <span class="value" style="color: #d4af37;">{{ total_expected_profit|floatformat:2|default:"0.00" }} <small>ج.م</small></span>
            </div>
            <span class="material-symbols-outlined icon-bg" style="color: rgba(212, 175, 55, 0.1);">trending_up</span>
        </div>
    </section>

    <section class="filter-section luxury-card" style="margin-bottom: 25px; padding: 20px; border: 1px solid #d4af37;">
        <form method="GET" style="display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; width: 100%;">
            
            <div style="flex: 2; min-width: 250px;">
                <label class="form-label" style="color: #d4af37; font-weight: bold; margin-bottom: 8px; display: block;">بحث سريع</label>
                <div style="position: relative;">
                    <input type="text" name="search" value="{{ search_query|default:'' }}" 
                           class="form-input-luxury" placeholder="الاسم أو كود الصنف...">
                    <span class="material-symbols-outlined" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #888;">search</span>
                </div>
            </div>
            
            <div style="flex: 1; min-width: 120px;">
                <label class="form-label">المقاس</label>
                <select name="size" class="form-select-luxury">
                    <option value="all">الكل</option>
                    {% for size in sizes %}
                    <option value="{{ size.id }}" {% if selected_size == size.id|stringformat:"i" %}selected{% endif %}>{{ size.size }}</option>
                    {% endfor %}
                </select>
            </div>

            <div style="flex: 1; min-width: 120px;">
                <label class="form-label">اللون</label>
                <select name="color" class="form-select-luxury">
                    <option value="all">الكل</option>
                    {% for color in colors %}
                    <option value="{{ color.id }}" {% if selected_color == color.id|stringformat:"i" %}selected{% endif %}>{{ color.color }}</option>
                    {% endfor %}
                </select>
            </div>

            <div style="flex: 1; min-width: 150px;">
                <label class="form-label">من تاريخ</label>
                <input type="date" name="start_date" value="{{ start_date }}" class="form-input-luxury">
            </div>

            <div style="flex: 1; min-width: 150px;">
                <label class="form-label">إلى تاريخ</label>
                <input type="date" name="end_date" value="{{ end_date }}" class="form-input-luxury">
            </div>

            <div style="display: flex; gap: 8px;">
                <button type="submit" class="btn-primary-luxury" style="height: 48px; width: 55px; justify-content: center; padding: 0;">
                    <span class="material-symbols-outlined">filter_list</span>
                </button>
                <a href="{% url 'inventory_management' %}" class="btn-secondary-luxury" 
                   style="text-decoration: none; height: 48px; width: 48px; display: flex; align-items: center; justify-content: center; border-radius: 12px; border: 1px solid #333;" 
                   title="إعادة تعيين">
                    <span class="material-symbols-outlined">restart_alt</span>
                </a>
            </div>
        </form>
    </section>

    <div class="inventory-table-container">
        <table class="luxury-data-table" id="inventoryTable">
            <thead>
                <tr>
                    <th>الصنف</th>
                    <th>الوحدة</th>
                    <th>المورد</th>
                    <th>المقاس</th>
                    <th>اللون</th>
                    <th>سعر البيع</th>
                    <th>الكمية</th>
                    <th>حد الطلب</th>
                    <th class="text-center">الإجراءات</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td><strong>{{ item.item.name }}</strong></td> 
                    
                    <td><span class="unit-badge">{{ item.item.unit }}</span></td>
                    <td><span class="table-text-muted">{{ item.item.Supplier.name|default:"-" }}</span></td>
                    
                    <td><span class="price-text">{{ item.size.size }} </span></td>
                    <td><span class="price-text">{{ item.color.color }} </span></td>
                    
                    <td><span class="price-text-gold">{{ item.item.unit_cost }} ج.م</span></td>
                    
                    <td>
                        <div class="status-badge-luxury {% if item.quantity <= item.min_limit %}status-red{% else %}status-green{% endif %}">
                            {{ item.quantity|floatformat:2 }}
                        </div>
                    </td>
                    <td>
                        <div class="status-badge-luxury {% if item.quantity <= item.min_limit %}status-red{% else %}status-green{% endif %}">
                            {{ item.min_limit }}
                        </div>
                    </td>
                    <td class="text-center">
                        <button onclick="openControlModal('{{ item.id }}', '{{ item.item.name }}', '{{ item.item.unit_cost }}', '{{ item.item.supply_cost }}', '{{ item.item.category.id }}', '{{ item.item.unit.id }}', '{{ item.size.id }}', '{{ item.color.id }}', '{{ item.quantity }}', '{{ item.min_limit }}')" class="btn-action-icon edit-btn">
                            <span class="material-symbols-outlined">settings</span>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="addItemModal" class="luxury-modal-overlay">
    <div class="modal-card large-card">
        <div class="modal-header-with-icon">
            <span class="material-symbols-outlined gold-text">add_box</span>
            <h3>إضافة صنف جديد وحساب مبالغ المورد</h3>
        </div>
        
        <form action="{% url 'add_inventory_item' %}" method="POST" class="luxury-form-grid">
            {% csrf_token %}
            
            <div class="full-row">
                <label class="form-label">اسم الصنف الأساسي</label>
                <input name="name" type="text" required class="form-input-luxury" placeholder="مثال: فستان سهرة">
            </div>

            <div class="half-row">
                <label class="form-label" style="color: #d4af37;">رقم هاتف المورد (للبحث)</label>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="sup_phone_search" name="supplier_phone_input" class="form-input-luxury" placeholder="أدخل الرقم...">
                    <button type="button" class="btn-primary-luxury" onclick="searchSupplier()">بحث</button>
                </div>
            </div>

            <div class="half-row">
                <label class="form-label">المورد المختار</label>
                <select name="Supplier" id="supplier_select" class="form-select-luxury">
                    <option value="">-- اختر مورد أو ابحث بالهاتف --</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}">{{ supplier.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div id="new_supplier_fields" class="full-row hidden-field" style="background: rgba(52, 152, 219, 0.1); padding: 15px; border-radius: 10px; border: 1px dashed #3498db;">
                <label class="form-label">اسم المورد الجديد</label>
                <input type="text" id="new_supplier_name" name="new_supplier_name" class="form-input-luxury" placeholder="سيتم إنشاء مورد جديد بهذا الاسم">
            </div>

            <div class="half-row">
                <label class="form-label">الفئة</label>
                <select name="category" class="form-select-luxury" required>
                    {% for cat in categories %}<option value="{{ cat.id }}">{{ cat }}</option>{% endfor %}
                </select>
            </div>
            <div class="half-row">
                <label class="form-label">الوحدة</label>
                <select name="unit" class="form-select-luxury" required>
                    {% for unit in units %}<option value="{{ unit.id }}">{{ unit }}</option>{% endfor %}
                </select>
            </div>

            <div class="full-row" style="background: rgba(212, 175, 55, 0.03); padding: 20px; border-radius: 15px; border: 1px solid rgba(212, 175, 55, 0.2); margin: 10px 0;">
                <h4 style="color: #d4af37; margin-bottom: 15px; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                    <span class="material-symbols-outlined">style</span>
                    تحديد الكميات لكل (مقاس + لون)
                </h4>
                <div id="variants-container">
                    <div class="variant-row" style="display: flex; gap: 10px; margin-bottom: 12px; align-items: center; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                        <select name="variant_size[]" class="form-select-luxury" style="flex: 2;" required>
                            <option value="">المقاس</option>
                            {% for size in sizes %}<option value="{{ size.id }}">{{ size.size }}</option>{% endfor %}
                        </select>
                        <select name="variant_color[]" class="form-select-luxury" style="flex: 2;" required>
                            <option value="">اللون</option>
                            {% for color in colors %}<option value="{{ color.id }}">{{ color.color }}</option>{% endfor %}
                        </select>
                        <input name="variant_quantity[]" type="number" placeholder="الكمية" class="form-input-luxury qty-input-variant" style="flex: 1.5; text-align: center;" required>
                        <button type="button" class="btn-action-icon" style="color: #ff4757;" onclick="removeVariantRow(this)">
                            <span class="material-symbols-outlined">delete</span>
                        </button>
                    </div>
                </div>
                <button type="button" class="btn-secondary-luxury" style="padding: 6px 15px; font-size: 0.85rem; border-style: dashed;" onclick="addVariantRow()">
                    <span class="material-symbols-outlined" style="font-size: 18px;">add</span> إضافة متغير آخر
                </button>
            </div>

            <div class="third-row">
                <label class="form-label">حد الطلب (للصنف الواحد)</label>
                <input name="min_limit" type="number" step="0.01" value="0" class="form-input-luxury">
            </div>
            <div class="third-row">
                <label class="form-label">تكلفة التوريد (للوحدة)</label>
                <input name="supply_cost" id="main_supply_cost" type="number" step="0.01" required value="0" class="form-input-luxury">
            </div>
            <div class="third-row">
                <label class="form-label">سعر البيع المقترح</label>
                <input name="unit_cost" id="main_unit_cost" type="number" step="0.01" required value="0" class="form-input-luxury">
            </div>

            <div class="half-row">
                <label class="form-label">الربح المتوقع (تلقائي)</label>
                <input name="profit" type="number" step="0.01" value="0" class="form-input-luxury" readonly style="background: rgba(39, 174, 96, 0.05); color: #27ae60; font-weight: bold;">
            </div>

            <div class="half-row" style="display: flex; align-items: center; gap: 15px; padding-top: 30px;">
                <input type="checkbox" name="is_rental" id="is_rental_check" class="form-checkbox-luxury">
                <label for="is_rental_check" class="form-label" style="margin: 0;">هل الصنف للإيجار؟</label>
            </div>

            <div class="full-row finance-summary-section" style="background: rgba(212, 175, 55, 0.05); padding: 15px; border-radius: 12px; border: 1px solid rgba(212, 175, 55, 0.3); margin-top: 15px;">
                <h4 style="color: #d4af37; margin-bottom: 12px; font-size: 0.95rem; display: flex; align-items: center; gap: 8px;">
                    <span class="material-symbols-outlined">account_balance_wallet</span>
                    ملخص الفاتورة الإجمالية للمورد
                </h4>
                <div class="luxury-form-grid">
                    <div class="half-row">
                        <label class="form-label">إجمالي المستحق (جميع الكميات)</label>
                        <input type="text" id="calc_total_display" class="form-input-luxury" readonly value="0.00" 
                               style="background: #111; color: #d4af37; font-weight: bold; border-color: rgba(212, 175, 55, 0.4);">
                    </div>
                    <div class="half-row">
                        <label class="form-label">المبلغ المدفوع فعلياً</label>
                        <input type="number" step="0.01" name="paid_amount" id="paid_amount_input" class="form-input-luxury" 
                               placeholder="اتركه للدفع الكامل" style="border-color: #27ae60;">
                        <small id="debt_hint" style="color: #ff4757; display: none; margin-top: 6px; font-weight: 600; font-size: 0.8rem;"></small>
                    </div>
                </div>
            </div>

            <div class="modal-footer-actions full-row">
                <button type="submit" class="btn-primary-luxury full-width">حفظ وتسجيل الحركة المالية</button>
                <button type="button" onclick="closeModal('addItemModal')" class="btn-secondary-luxury">إلغاء</button>
            </div>
        </form>
    </div>
</div>

<div id="controlModal" class="luxury-modal-overlay">
    <div class="control-modal">
        <input type="hidden" id="control_item_id_delete"> 

        <div class="tabs-header">
            <button class="tab-btn active" onclick="switchTab(event, 'supply-tab')">توريد كمية</button>
            <button class="tab-btn" onclick="switchTab(event, 'edit-tab')">بيانات الصنف</button>
            <button class="tab-btn" onclick="switchTab(event, 'delete-tab')" style="color: #e74c3c;">حذف</button>
        </div>

        <div id="supply-tab" class="tab-content active">
            <form id="supplyForm" action="{% url 'update_inventory_quantity' %}" method="POST">
            {% csrf_token %}
            <input type="hidden" name="item_id" id="control_item_id_supply">
            
            <input type="hidden" name="unit_cost" id="supply_hidden_unit_cost">
            <input type="hidden" name="supply_cost" id="supply_hidden_supply_cost">

            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                </div>

            <div class="form-group-luxury" style="margin-bottom: 15px;">
                <label class="form-label">الكمية الجديدة المضافة</label>
                <input name="quantity_added" type="number" step="0.01" class="form-input-luxury" required>
            </div>
            </form>
        </div>

        <div id="edit-tab" class="tab-content">
    <form id="editForm" action="{% url 'update_inventory_quantity' %}" method="POST">
        {% csrf_token %}
        <input type="hidden" name="item_id" id="control_item_id_edit">
        
        <div class="form-group-luxury" style="margin-bottom: 12px;">
            <label class="form-label">اسم الصنف</label>
            <input name="name" type="text" id="edit_name_input" class="form-input-luxury" required>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 12px;">
            <div style="flex: 1;">
                <label class="form-label">الفئة</label>
                <select name="category" id="edit_category" class="form-select-luxury">
                    {% for cat in categories %}<option value="{{ cat.id }}">{{ cat }}</option>{% endfor %}
                </select>
            </div>
            <div style="flex: 1;">
                <label class="form-label">الوحدة</label>
                <select name="unit" id="edit_unit" class="form-select-luxury">
                    {% for unit in units %}<option value="{{ unit.id }}">{{ unit }}</option>{% endfor %}
                </select>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 12px;">
            <div style="flex: 1;">
                <label class="form-label">المقاس</label>
                <select name="size" id="edit_size" class="form-select-luxury">
                    {% for size in sizes %}<option value="{{ size.id }}">{{ size.size }}</option>{% endfor %}
                </select>
            </div>
            <div style="flex: 1;">
                <label class="form-label">اللون</label>
                <select name="color" id="edit_color" class="form-select-luxury">
                    {% for color in colors %}<option value="{{ color.id }}">{{ color.color }}</option>{% endfor %}
                </select>
            </div>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 12px;">
            <div style="flex: 1;">
                <label class="form-label">الكمية الحالية</label>
                <input name="quantity" type="number" step="0.01" id="edit_quantity" class="form-input-luxury">
            </div>
            <div style="flex: 1;">
                <label class="form-label">حد الطلب</label>
                <input name="min_limit" type="number" step="0.01" id="edit_min_limit" class="form-input-luxury">
            </div>
        </div>

        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label class="form-label">سعر البيع</label>
                <input name="unit_cost" type="number" step="0.01" id="edit_unit_cost_input" class="form-input-luxury">
            </div>
            <div style="flex: 1;">
                <label class="form-label">تكلفة الشراء</label>
                <input name="supply_cost" type="number" step="0.01" id="edit_supply_cost_input" class="form-input-luxury">
            </div>
        </div>

        <button type="button" onclick="submitEditAjax()" class="btn-primary-luxury full-width" style="margin-top: 20px;">حفظ التغييرات الشاملة</button>
    </form>
</div>
        
    

        <div id="delete-tab" class="tab-content">
            <div style="text-align: center; padding: 20px;">
                <span class="material-symbols-outlined" style="font-size: 48px; color: #e74c3c; margin-bottom: 10px;">warning</span>
                <h4 style="color: #fff; margin-bottom: 10px;">حذف الصنف نهائياً؟</h4>
                <p style="color: #888; font-size: 0.85rem; margin-bottom: 20px;">سيؤدي هذا الإجراء إلى إزالة الصنف من المخازن تماماً.</p>
                
                <form action="{% url 'delete_inventory_item' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="item_id" id="control_item_id_final_delete">
                    <button type="submit" class="btn-danger">تأكيد الحذف</button>
                </form>
            </div>
        </div>
    </div>
</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 1. وظائف إضافة وحذف صفوف المتغيرات (المقاس واللون)
    function addVariantRow() {
        const container = document.getElementById('variants-container');
        const firstRow = container.querySelector('.variant-row');
        const newRow = firstRow.cloneNode(true);
        
        // تفريغ المدخلات في الصف الجديد لضمان عدم تكرار بيانات الصف الأول
        newRow.querySelectorAll('input').forEach(input => {
            input.value = '';
            input.dataset.userEdited = ""; // إعادة تعيين حالة التعديل
        });
        newRow.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
        
        container.appendChild(newRow);
        attachQtyListeners(); // ربط مستمعات الأحداث فوراً بالصف الجديد
    }

    function removeVariantRow(btn) {
        const container = document.getElementById('variants-container');
        const rows = container.querySelectorAll('.variant-row');
        
        if (rows.length > 1) {
            btn.closest('.variant-row').remove();
            updateFinance(); // إعادة حساب الإجمالي بعد حذف صف
        } else {
            alert("يجب أن يحتوي الصنف على متغير واحد على الأقل (مقاس/لون)");
        }
    }

    // 2. ربط مستمعات الأحداث لكل حقول الكمية المضافة ديناميكياً
    function attachQtyListeners() {
        document.querySelectorAll('.qty-input-variant').forEach(input => {
            // إزالة المستمع القديم لتجنب تكرار التنفيذ (Double Firing)
            input.removeEventListener('input', updateFinance); 
            input.addEventListener('input', updateFinance);
        });
    }

    // 3. وظيفة الإرسال عبر AJAX (توريد كمية أو تعديل صنف)
    function handleAjaxSubmit(formId, successCallback) {
        const form = document.getElementById(formId);
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                if (successCallback) successCallback(data);
                location.reload(); 
            } else {
                alert("خطأ: " + (data.message || "حدث خطأ غير متوقع"));
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("حدث خطأ في الاتصال بالسيرفر، يرجى المحاولة لاحقاً");
        });
    }

    function submitSupplyAjax() {
    const form = document.getElementById('supplyForm');
    const formData = new FormData(form);

    fetch("{% url 'update_inventory_quantity' %}", {
        method: "POST",
        body: formData,
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message);
        }
    });
}

    function submitEditAjax() {
    const form = document.getElementById('editForm');
    const formData = new FormData(form);

    // إضافة تأكيد للمستخدم قبل الإرسال
    if(!confirm("هل أنت متأكد من حفظ التغييرات الشاملة على الصنف؟")) return;

    fetch(form.action, { // سيذهب إلى update_inventory_quantity
        method: "POST",
        body: formData,
        headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "X-Requested-With": "XMLHttpRequest"
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert("تم التحديث بنجاح");
            location.reload();
        } else {
            // في حال وجود خطأ من السيرفر (مثل مشكلة السعر أو حد الطلب)
            alert("فشل التحديث: " + data.message);
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("حدث خطأ تقني أثناء التحديث");
    });
}

    // 4. الدوال الأساسية للنوافذ (Modals)
    function openModal(id) { 
        const modal = document.getElementById(id);
        if(modal) modal.style.display = 'flex'; 
    }
    
    function closeModal(id) { 
        const modal = document.getElementById(id);
        if(modal) modal.style.display = 'none'; 
    }

    function openControlModal(id, name, unitCost, supplyCost, catId, unitId, sizeId, colorId, qty, minLimit) {
        // تعبئة المعرفات
        const ids = ['control_item_id_supply', 'control_item_id_edit', 'control_item_id_final_delete', 'control_item_id_delete'];
        ids.forEach(idName => {
            let el = document.getElementById(idName);
            if(el) el.value = id;
        });

        // تعبئة بيانات التعديل الشامل
        if(document.getElementById('edit_name_input')) document.getElementById('edit_name_input').value = name;
        if(document.getElementById('edit_unit_cost_input')) document.getElementById('edit_unit_cost_input').value = unitCost;
        if(document.getElementById('edit_supply_cost_input')) document.getElementById('edit_supply_cost_input').value = supplyCost;
        if(document.getElementById('edit_quantity')) document.getElementById('edit_quantity').value = qty;
        if(document.getElementById('edit_min_limit')) document.getElementById('edit_min_limit').value = minLimit;

        // --- الإضافة الجديدة: تعبئة الأسعار المخفية لتبويب التوريد ---
        if(document.getElementById('supply_hidden_unit_cost')) document.getElementById('supply_hidden_unit_cost').value = unitCost;
        if(document.getElementById('supply_hidden_supply_cost')) document.getElementById('supply_hidden_supply_cost').value = supplyCost;

        // تعبئة القوائم
        if(document.getElementById('edit_category')) document.getElementById('edit_category').value = catId;
        if(document.getElementById('edit_unit')) document.getElementById('edit_unit').value = unitId;
        if(document.getElementById('edit_size')) document.getElementById('edit_size').value = sizeId;
        if(document.getElementById('edit_color')) document.getElementById('edit_color').value = colorId;
        
        if(document.getElementById('supply_size')) document.getElementById('supply_size').value = sizeId;
        if(document.getElementById('supply_color')) document.getElementById('supply_color').value = colorId;

        openModal('controlModal');
    }

    function switchTab(evt, tabId) {
        const contents = document.getElementsByClassName("tab-content");
        for (let content of contents) content.classList.remove("active");
        
        const buttons = document.getElementsByClassName("tab-btn");
        for (let btn of buttons) btn.classList.remove("active");
        
        document.getElementById(tabId).classList.add("active");
        evt.currentTarget.classList.add("active");
    }

    // 5. وظيفة البحث عن المورد (محسنة)
    function searchSupplier() {
        const phone = document.getElementById('sup_phone_search').value.trim();
        const select = document.getElementById('supplier_select');
        const newFields = document.getElementById('new_supplier_fields');
        const phoneInput = document.getElementById('sup_phone_search');

        if (!phone) {
            alert('يرجى إدخال رقم الهاتف أولاً');
            return;
        }

        fetch(`{% url 'check_supplier_by_phone' %}?phone=${phone}`)
            .then(res => res.json())
            .then(data => {
                phoneInput.classList.remove('search-success', 'search-new');
                if (data.found) {
                    select.value = data.id;
                    newFields.classList.add('hidden-field');
                    phoneInput.classList.add('search-success');
                    alert('تم العثور على المورد: ' + data.name);
                } else {
                    select.value = "";
                    newFields.classList.remove('hidden-field');
                    phoneInput.classList.add('search-new');
                    document.getElementById('new_supplier_name').focus();
                    alert('رقم جديد. يرجى إدخال اسم المورد لحفظه');
                }
            })
            .catch(err => alert('خطأ في الاتصال بقاعدة البيانات'));
    }

    // 6. منطق الحسابات المالية (Finance Logic)
    function updateFinance() {
    let totalQtyAdded = 0;
    // نجمع الكميات المكتوبة في حقول "الكمية المضافة" (quantity_added)
    document.querySelectorAll('input[name="quantity_added"]').forEach(input => {
        totalQtyAdded += parseFloat(input.value) || 0;
    });

    // إذا لم يوجد حقل مصفوفة، نأخذ الكمية من الحقل الفردي (للتوافق القديم)
    if (totalQtyAdded === 0) {
        totalQtyAdded = parseFloat(document.getElementById('edit_quantity')?.value) || 0;
    }

    const supplyCost = parseFloat(document.getElementById('edit_supply_cost_input')?.value) || 
                      parseFloat(document.getElementById('main_supply_cost')?.value) || 0;
    
    const unitPrice = parseFloat(document.getElementById('edit_unit_cost_input')?.value) || 
                     parseFloat(document.getElementById('main_unit_cost')?.value) || 0;

    const totalDisplay = document.getElementById('calc_total_display');
    const paidInput = document.getElementById('paid_amount_input');
    const profitInput = document.querySelector('input[name="profit"]');

    // حساب إجمالي المبلغ المطلوب للمورد
    const totalAmount = (totalQtyAdded * supplyCost).toFixed(2);
    if(totalDisplay) totalDisplay.value = totalAmount;
    
    if(paidInput && !paidInput.dataset.userEdited) {
        paidInput.value = totalAmount;
    }

    // حساب الربح
    if (profitInput) {
        profitInput.value = (unitPrice - supplyCost).toFixed(2);
    }

    checkDebt();
}

    function checkDebt() {
        const total = parseFloat(document.getElementById('calc_total_display')?.value) || 0;
        const paid = parseFloat(document.getElementById('paid_amount_input')?.value) || 0;
        const debtHint = document.getElementById('debt_hint');

        if (debtHint) {
            if (paid < total) {
                debtHint.style.display = 'block';
                debtHint.innerText = `متبقي مديونية للمورد: ${(total - paid).toFixed(2)} ج.م`;
            } else {
                debtHint.style.display = 'none';
            }
        }
    }

    // 7. تهيئة الصفحة عند التحميل
    document.addEventListener('DOMContentLoaded', function() {
        attachQtyListeners();
        
        // مراقبة حقول التكلفة والبيع لتحديث الحسابات
        ['main_supply_cost', 'main_unit_cost'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', updateFinance);
        });
        
        // مراقبة حقل المدفوع لمنع التحديث التلقائي بعد تعديل المستخدم
        const paidInput = document.getElementById('paid_amount_input');
        if(paidInput) {
            paidInput.addEventListener('input', function() {
                this.dataset.userEdited = "true";
                checkDebt();
            });
        }
    });
</script>
{% endblock %}